Crafty.c("Car",{Car:function(b){this._speed=0;this._acceleration=0.5;this._brakes=0.9;this._maxSpeed=7;this.rotation=b;this._handling=3;this._previousCheckpoint="";this.checkpointsPassed=0;this.goalEnabled=!1;this.reverseCounter=0;this.offroadCounter=1;this.bind("EnterFrame",function(b){var n=0,o=!1;2<this.offroadCounter?this.offroadCounter=2:1!=Crafty(Crafty("MapData")[0]).getSpeed(this.x+this.w/2,this.y+this.h/2)?this.offroadCounter+=0.02:1<this.offroadCounter&&(this.offroadCounter-=1);1>this.offroadCounter&&
(this.offroadCounter=1);this.isDown(Crafty.keys.W)&&(0==starttime&&(starttime=20*b.frame),this.reverseCounter=0,this._speed=1<this._speed?this._speed+this._acceleration/this._speed/this.offroadCounter:this._speed+this._acceleration/this.offroadCounter);this._speed=0.98*this._speed/this.offroadCounter;if(this.isDown(Crafty.keys.S)&&(0==starttime&&(starttime=20*b.frame),0==this._speed&&10>this.reverseCounter&&this.reverseCounter++,1<this._speed?(b=this._brakes/this._speed,0.4>b&&(b=0.4),this._speed-=
b):this._speed-=this._brakes/this.offroadCounter,0>this._speed&&10>this.reverseCounter))this._speed=0;this.isDown(Crafty.keys.SPACE)&&(this._speed-=this._speed/10,n=0.2,o=!0);this.isDown(Crafty.keys.A)&&(1<=this._speed&&(n+=this._speed*this._speed/this._maxSpeed),1>n&&!o&&(n=1),this.rotation-=this._speed*this._handling/n);this.isDown(Crafty.keys.D)&&(1<=this._speed&&(n+=this._speed*this._speed/this._maxSpeed),1>n&&!o&&(n=1),this.rotation+=this._speed*this._handling/n);this._speed>this._maxSpeed&&
(this._speed=this._maxSpeed);-2>this._speed&&(this._speed=-2);if(("A"==Crafty(Crafty("MapData")[0]).getPixel(parseInt(this.x+this.w/2),parseInt(this.y+this.h/2))||Crafty(Crafty("MapData")[0]).getPixel(parseInt(this.x+this.w/2),parseInt(this.y+this.h/2)))&&Crafty(Crafty("MapData")[0]).getPixel(parseInt(this.x+this.w/2),parseInt(this.y+this.h/2))!=this.previousCheckpoint)this.previousCheckpoint=Crafty(Crafty("MapData")[0]).getPixel(parseInt(this.x+this.w/2),parseInt(this.y+this.h/2)),this.checkpointsPassed++,
0==Crafty(Crafty("Map")[0]).getNumberOfCheckpoints()-this.checkpointsPassed&&(this.goalEnabled=!0);"goal"==Crafty(Crafty("MapData")[0]).getPixel(parseInt(this.x+this.w/2),parseInt(this.y+this.h/2))&&!0==this.goalEnabled&&Crafty.scene("race_over");this.x+=Math.sin(this._rotation*Math.PI/180)*this._speed;this.y+=Math.cos(this._rotation*Math.PI/180)*-this._speed});return this}});(function(b){function g(){var a=B++;return a in t?g():a}function n(a){if(null===a||"object"!=typeof a)return a;var d=a.constructor(),b;for(b in a)d[b]=n(a[b]);return d}var o=function(a){return new o.fn.init(a)},B=1,D=1,u={},t={},v={},x,F,z,C=0,s=(new Date).getTime(),a=Array.prototype.slice,d=/\s*,\s*/,c=/\s+/;o.fn=o.prototype={init:function(a){if("string"===typeof a){var b=0,i,h,m=!1,k=!1,p,g,r,w,A;if("*"===a){for(i in t)this[+i]=t[i],b++;this.length=b;return this}-1!==a.indexOf(",")?(k=!0,p=d):-1!==
a.indexOf(" ")&&(m=!0,p=c);for(i in t)if(t.hasOwnProperty(i))if(h=t[i],m||k){g=a.split(p);w=0;A=g.length;for(r=0;w<A;w++)h.__c[g[w]]&&r++;if(m&&r===A||k&&0<r)this[b++]=+i}else h.__c[a]&&(this[b++]=+i);0<b&&(!m&&!k)&&this.extend(u[a]);if(g&&m)for(w=0;w<A;w++)this.extend(u[g[w]]);this.length=b}else{a||(a=0,a in t||(t[a]=this));if(!(a in t))return this.length=0,this;this[0]=a;this.length=1;this.__c||(this.__c={});t[a]||(t[a]=this);return t[a]}return this},setName:function(a){this._entityName=a=String(a);
this.trigger("NewEntityName",a);return this},addComponent:function(a){var b=[],c=0,h;h=0;var m,k;if(1<arguments.length)for(m=arguments.length;h<m;h++)this.__c[arguments[h]]=!0,b.push(arguments[h]);else if(-1!==a.indexOf(",")){k=a.split(d);for(m=k.length;h<m;h++)this.__c[k[h]]=!0,b.push(k[h])}else this.__c[a]=!0,b.push(a);for(h=b.length;c<h;c++)comp=u[b[c]],this.extend(comp),comp&&"init"in comp&&comp.init.call(this);this.trigger("NewComponent",h);return this},toggleComponent:function(a){var b=0,c,
h;if(1<arguments.length)for(c=arguments.length;b<c;b++)this.has(arguments[b])?this.removeComponent(arguments[b]):this.addComponent(arguments[b]);else if(-1!==a.indexOf(",")){h=a.split(d);for(c=h.length;b<c;b++)this.has(h[b])?this.removeComponent(h[b]):this.addComponent(h[b])}else this.has(a)?this.removeComponent(a):this.addComponent(a);return this},requires:function(a){for(var a=a.split(d),b=0,c=a.length,h;b<c;++b)h=a[b],this.has(h)||this.addComponent(h);return this},removeComponent:function(a,d){if(!1===
d){var b=u[a],c;for(c in b)delete this[c]}delete this.__c[a];this.trigger("RemoveComponent",a);return this},has:function(a){return!!this.__c[a]},attr:function(a,d){if(1===arguments.length){if("string"===typeof a)return this[a];this.extend(a);this.trigger("Change",a);return this}this[a]=d;var b={};b[a]=d;this.trigger("Change",b);return this},toArray:function(){return a.call(this,0)},timeout:function(a,d){this.each(function(){var b=this;setTimeout(function(){a.call(b)},d)});return this},bind:function(a,
d){if(1===this.length){v[a]||(v[a]={});var b=v[a];b[this[0]]||(b[this[0]]=[]);b[this[0]].push(d);return this}this.each(function(){v[a]||(v[a]={});var b=v[a];b[this[0]]||(b[this[0]]=[]);b[this[0]].push(d)});return this},unbind:function(a,d){this.each(function(){var b=v[a],c=0,m,k;if(b&&b[this[0]])m=b[this[0]].length;else return this;if(!d)return delete b[this[0]],this;for(;c<m;c++)k=b[this[0]],k[c]==d&&(k.splice(c,1),c--)});return this},trigger:function(a,d){if(1===this.length){if(v[a]&&v[a][this[0]])for(var b=
v[a][this[0]],c=0,m=b.length;c<m;c++)b[c].call(this,d);return this}this.each(function(){if(v[a]&&v[a][this[0]])for(var b=v[a][this[0]],c=0,i=b.length;c<i;c++)b[c].call(this,d)});return this},each:function(a){for(var d=0,b=this.length;d<b;d++)t[this[d]]&&a.call(t[this[d]],d);return this},clone:function(){var a=this.__c,d,b,c=o.e();for(d in a)c.addComponent(d);for(b in this)"0"!=b&&("_global"!=b&&"_changed"!=b&&"function"!=typeof this[b]&&"object"!=typeof this[b])&&(c[b]=this[b]);return c},setter:function(a,
d){o.support.setter?this.__defineSetter__(a,d):o.support.defineProperty?Object.defineProperty(this,a,{set:d,configurable:!0}):z.push({prop:a,obj:this,fn:d});return this},destroy:function(){this.each(function(){this.trigger("Remove");for(var a in v)this.unbind(a);delete t[this[0]]})}};o.fn.init.prototype=o.fn;o.extend=o.fn.extend=function(a){var d;if(!a)return this;for(d in a)this!==a[d]&&(this[d]=a[d]);return this};o.extend({init:function(a,d){o.viewport.init(a,d);this.trigger("Load");this.timer.init();
return this},getVersion:function(){return"0.4.8"},stop:function(){this.timer.stop();o.stage.elem.parentNode.removeChild(o.stage.elem);return this},pause:function(a){(1==arguments.length?a:!this._paused)?(this.trigger("Pause"),this._paused=!0,o.timer.stop(),o.keydown={}):(this.trigger("Unpause"),this._paused=!1,o.timer.init());return this},isPaused:function(){return this._paused},timer:{prev:+new Date,current:+new Date,curTime:Date.now(),init:function(){var a=b.requestAnimationFrame||b.webkitRequestAnimationFrame||
b.mozRequestAnimationFrame||b.oRequestAnimationFrame||b.msRequestAnimationFrame||null;a?(x=function(){o.timer.step();F=a(x)},x()):x=setInterval(o.timer.step,20)},stop:function(){o.trigger("CraftyStop");"number"===typeof x&&clearInterval(x);var a=b.cancelRequestAnimationFrame||b.webkitCancelRequestAnimationFrame||b.mozCancelRequestAnimationFrame||b.oCancelRequestAnimationFrame||b.msCancelRequestAnimationFrame||null;a&&a(F);x=null},step:function(){C=0;this.curTime=Date.now();for(1200<this.curTime-s&&
(s=this.curTime-20);this.curTime>s;)o.trigger("EnterFrame",{frame:D++}),s+=20,C++;C&&o.DrawManager.draw()},getFPS:function(){return 50},simulateFrames:function(a){for(;0<a--;)o.trigger("EnterFrame",{frame:D++});o.DrawManager.draw()}},e:function(){var a=g(),d;t[a]=null;t[a]=d=o(a);0<arguments.length&&d.addComponent.apply(d,arguments);d.setName("Entity #"+a);d.addComponent("obj");o.trigger("NewEntity",{id:a});return d},c:function(a,d){u[a]=d},trigger:function(a,d){var b=v[a],c,m,k;for(c in b)if(b.hasOwnProperty(c)){m=
0;for(k=b[c].length;m<k;m++)b[c]&&b[c][m]&&(t[c]?b[c][m].call(o(+c),d):b[c][m].call(o,d))}},bind:function(a,d){v[a]||(v[a]={});var b=v[a];b.global||(b.global=[]);return b.global.push(d)-1},unbind:function(a,d){var b=v[a],c,m,k;for(c in b)if(b.hasOwnProperty(c)){if("number"===typeof d)return delete b[c][d],!0;m=0;for(k=b[c].length;m<k;m++)if(b[c][m]===d)return delete b[c][m],!0}return!1},frame:function(){return D},components:function(){return u},isComp:function(a){return a in u},debug:function(){return t},
settings:function(){var a={},d={};return{register:function(a,b){d[a]=b},modify:function(b,c){d[b]&&(d[b].call(a[b],c),a[b]=c)},get:function(d){return a[d]}}}(),clone:n});o.bind("Load",function(){!o.support.setter&&o.support.defineProperty&&(z=[],o.bind("EnterFrame",function(){for(var a=0,d=z.length,b;a<d;++a)b=z[a],b.obj[b.prop]!==b.obj["_"+b.prop]&&b.fn.call(b.obj,b.obj[b.prop])}))});b.Crafty=o})(window);
(function(b,g,n){function o(){if(!(0>=this._numProps)){var a,d;for(d in this._step)a=this._step[d],this[d]+=a.val,0==--a.rem&&(this[d]=a.prop,this.trigger("TweenEnd",d),0>=this._step[d].rem&&delete this._step[d],this._numProps--);if(this.has("Mouse"))if(a=b.over,d=b.mousePos,a&&a[0]==this[0]&&!this.isAt(d.x,d.y))this.trigger("MouseOut",b.lastEvent),b.over=null;else if((!a||a[0]!=this[0])&&this.isAt(d.x,d.y))b.over=this,this.trigger("MouseOver",b.lastEvent)}}var B=function(a,d,b){this.keys=a;this.map=
b;this.obj=d},D,u=function(a){D=a||64;this.map={}};u.prototype={insert:function(a){for(var d=u.key(a),b=new B(d,a,this),e=0,f,i,e=d.x1;e<=d.x2;e++)for(f=d.y1;f<=d.y2;f++)i=e+" "+f,this.map[i]||(this.map[i]=[]),this.map[i].push(a);return b},search:function(a,d){var b=u.key(a),e,f,i,h=[];void 0===d&&(d=!0);for(e=b.x1;e<=b.x2;e++)for(f=b.y1;f<=b.y2;f++)i=e+" "+f,this.map[i]&&(h=h.concat(this.map[i]));if(d){var m;f=[];i={};e=0;for(l=h.length;e<l;e++)if(m=h[e])b=m[0],!i[b]&&(m.x<a._x+a._w&&m._x+m._w>a._x&&
m.y<a._y+a._h&&m._h+m._y>a._y)&&(i[b]=h[e]);for(m in i)f.push(i[m]);return f}return h},remove:function(a,d){var b=0,e,f;1==arguments.length&&(d=a,a=u.key(d));for(b=a.x1;b<=a.x2;b++)for(e=a.y1;e<=a.y2;e++)if(f=b+" "+e,this.map[f]){f=this.map[f];var i,h=f.length;for(i=0;i<h;i++)f[i]&&f[i][0]===d[0]&&f.splice(i,1)}},boundaries:function(){var a,d,b=-Infinity,e=-Infinity,f=Infinity,i=Infinity,h={max:{x:-Infinity,y:-Infinity},min:{x:Infinity,y:Infinity}},m;for(m in this.map)if(this.map[m].length){d=m.split(" ");
var k=d[0],g=d[0];if(k>=b)for(a in b=k,this.map[m])d=this.map[m][a],"object"==typeof d&&"requires"in d&&(h.max.x=Math.max(h.max.x,d.x+d.w));if(k<=f)for(a in f=k,this.map[m])d=this.map[m][a],"object"==typeof d&&"requires"in d&&(h.min.x=Math.min(h.min.x,d.x));if(g>=e)for(a in e=g,this.map[m])d=this.map[m][a],"object"==typeof d&&"requires"in d&&(h.max.y=Math.max(h.max.y,d.y+d.h));if(g<=i)for(a in i=g,this.map[m])d=this.map[m][a],"object"==typeof d&&"requires"in d&&(h.min.y=Math.min(h.min.y,d.y))}return h}};
u.key=function(a){a.hasOwnProperty("mbr")&&(a=a.mbr());return{x1:Math.floor(a._x/D),y1:Math.floor(a._y/D),x2:Math.floor((a._w+a._x)/D),y2:Math.floor((a._h+a._y)/D)}};u.hash=function(a){return a.x1+" "+a.y1+" "+a.x2+" "+a.y2};B.prototype={update:function(a){u.hash(u.key(a))!=u.hash(this.keys)&&(this.map.remove(this.keys,this.obj),this.keys=this.map.insert(this.obj).keys)}};b.HashMap=u;b.map=new b.HashMap;var t=Math.PI/180;b.c("2D",{_x:0,_y:0,_w:0,_h:0,_z:0,_rotation:0,_alpha:1,_visible:!0,_globalZ:null,
_origin:null,_mbr:null,_entry:null,_children:null,_parent:null,_changed:!1,_defineGetterSetter_setter:function(){this.__defineSetter__("x",function(a){this._attr("_x",a)});this.__defineSetter__("y",function(a){this._attr("_y",a)});this.__defineSetter__("w",function(a){this._attr("_w",a)});this.__defineSetter__("h",function(a){this._attr("_h",a)});this.__defineSetter__("z",function(a){this._attr("_z",a)});this.__defineSetter__("rotation",function(a){this._attr("_rotation",a)});this.__defineSetter__("alpha",
function(a){this._attr("_alpha",a)});this.__defineSetter__("visible",function(a){this._attr("_visible",a)});this.__defineGetter__("x",function(){return this._x});this.__defineGetter__("y",function(){return this._y});this.__defineGetter__("w",function(){return this._w});this.__defineGetter__("h",function(){return this._h});this.__defineGetter__("z",function(){return this._z});this.__defineGetter__("rotation",function(){return this._rotation});this.__defineGetter__("alpha",function(){return this._alpha});
this.__defineGetter__("visible",function(){return this._visible});this.__defineGetter__("parent",function(){return this._parent});this.__defineGetter__("numChildren",function(){return this._children.length})},_defineGetterSetter_defineProperty:function(){Object.defineProperty(this,"x",{set:function(a){this._attr("_x",a)},get:function(){return this._x},configurable:!0});Object.defineProperty(this,"y",{set:function(a){this._attr("_y",a)},get:function(){return this._y},configurable:!0});Object.defineProperty(this,
"w",{set:function(a){this._attr("_w",a)},get:function(){return this._w},configurable:!0});Object.defineProperty(this,"h",{set:function(a){this._attr("_h",a)},get:function(){return this._h},configurable:!0});Object.defineProperty(this,"z",{set:function(a){this._attr("_z",a)},get:function(){return this._z},configurable:!0});Object.defineProperty(this,"rotation",{set:function(a){this._attr("_rotation",a)},get:function(){return this._rotation},configurable:!0});Object.defineProperty(this,"alpha",{set:function(a){this._attr("_alpha",
a)},get:function(){return this._alpha},configurable:!0});Object.defineProperty(this,"visible",{set:function(a){this._attr("_visible",a)},get:function(){return this._visible},configurable:!0})},_defineGetterSetter_fallback:function(){this.x=this._x;this.y=this._y;this.w=this._w;this.h=this._h;this.z=this._z;this.rotation=this._rotation;this.alpha=this._alpha;this.visible=this._visible;this.bind("EnterFrame",function(){if(this.x!==this._x||this.y!==this._y||this.w!==this._w||this.h!==this._h||this.z!==
this._z||this.rotation!==this._rotation||this.alpha!==this._alpha||this.visible!==this._visible){var a=this.mbr()||this.pos();if(this.rotation!==this._rotation)this._rotate(this.rotation);else{var d=this._mbr,b=!1;d&&(this.x!==this._x?(d._x-=this.x-this._x,b=!0):this.y!==this._y?(d._y-=this.y-this._y,b=!0):this.w!==this._w?(d._w-=this.w-this._w,b=!0):this.h!==this._h?(d._h-=this.h-this._h,b=!0):this.z!==this._z&&(d._z-=this.z-this._z,b=!0));b&&this.trigger("Move",a)}this._x=this.x;this._y=this.y;
this._w=this.w;this._h=this.h;this._z=this.z;this._rotation=this.rotation;this._alpha=this.alpha;this._visible=this.visible;this.trigger("Change",a);this.trigger("Move",a)}})},init:function(){this._globalZ=this[0];this._origin={x:0,y:0};this._children=[];b.support.setter?this._defineGetterSetter_setter():b.support.defineProperty?this._defineGetterSetter_defineProperty():this._defineGetterSetter_fallback();this._entry=b.map.insert(this);this.bind("Move",function(a){this._entry.update(this._mbr||this);
this._cascade(a)});this.bind("Rotate",function(a){this._entry.update(this._mbr||this);this._cascade(a)});this.bind("Remove",function(){if(this._children){for(var a=0;a<this._children.length;a++)this._children[a].destroy&&this._children[a].destroy();this._children=[]}b.map.remove(this);this.detach()})},_rotate:function(a){var d=-1*(a%360),b=d*t,e=Math.cos(b),b=Math.sin(b),f=this._origin.x+this._x,i=this._origin.y+this._y;if(!d&&(this._mbr=null,!this._rotation%360))return;var h=f+(this._x-f)*e+(this._y-
i)*b,m=i-(this._x-f)*b+(this._y-i)*e,k=f+(this._x+this._w-f)*e+(this._y-i)*b,g=i-(this._x+this._w-f)*b+(this._y-i)*e,q=f+(this._x+this._w-f)*e+(this._y+this._h-i)*b,r=i-(this._x+this._w-f)*b+(this._y+this._h-i)*e,w=f+(this._x-f)*e+(this._y+this._h-i)*b,A=i-(this._x-f)*b+(this._y+this._h-i)*e,d=Math.floor(Math.min(h,k,q,w)),E=Math.floor(Math.min(m,g,r,A)),h=Math.ceil(Math.max(h,k,q,w)),m=Math.ceil(Math.max(m,g,r,A));this._mbr={_x:d,_y:E,_w:h-d,_h:m-E};a=this._rotation-a;d=a*t;this.trigger("Rotate",
{cos:Math.cos(d),sin:Math.sin(d),deg:a,rad:d,o:{x:f,y:i},matrix:{M11:e,M12:b,M21:-b,M22:e}})},area:function(){return this._w*this._h},intersect:function(a,d,b,e){var f=this._mbr||this,a="object"===typeof a?a:{x:a,y:d,w:b,h:e};return f._x<a.x+a.w&&f._x+f._w>a.x&&f._y<a.y+a.h&&f._h+f._y>a.y},within:function(a,d,b,e){a="object"===typeof a?a:{x:a,y:d,w:b,h:e};return a.x<=this.x&&a.x+a.w>=this.x+this.w&&a.y<=this.y&&a.y+a.h>=this.y+this.h},contains:function(a,d,b,e){a="object"===typeof a?a:{x:a,y:d,w:b,
h:e};return a.x>=this.x&&a.x+a.w<=this.x+this.w&&a.y>=this.y&&a.y+a.h<=this.y+this.h},pos:function(){return{_x:this._x,_y:this._y,_w:this._w,_h:this._h}},mbr:function(){return!this._mbr?this.pos():{_x:this._mbr._x,_y:this._mbr._y,_w:this._mbr._w,_h:this._mbr._h}},isAt:function(a,d){return this.mapArea?this.mapArea.containsPoint(a,d):this.map?this.map.containsPoint(a,d):this.x<=a&&this.x+this.w>=a&&this.y<=d&&this.y+this.h>=d},move:function(a,d){"n"===a.charAt(0)&&(this.y-=d);"s"===a.charAt(0)&&(this.y+=
d);if("e"===a||"e"===a.charAt(1))this.x+=d;if("w"===a||"w"===a.charAt(1))this.x-=d;return this},shift:function(a,d,b,e){a&&(this.x+=a);d&&(this.y+=d);b&&(this.w+=b);e&&(this.h+=e);return this},_cascade:function(a){if(a){var d=0,b=this._children,e=b.length,f;if(a.cos)for(;d<e;++d)f=b[d],"rotate"in f&&f.rotate(a);else{f=this._mbr||this;for(var i=f._x-a._x,h=f._y-a._y,m=f._w-a._w,a=f._h-a._h;d<e;++d)f=b[d],f.shift(i,h,m,a)}}},attach:function(){for(var a=0,d=arguments,b=arguments.length,e;a<b;++a)e=d[a],
e._parent&&e._parent.detach(e),e._parent=this,this._children.push(e);return this},detach:function(a){if(!a){for(var d=0;d<this._children.length;d++)this._children[d]._parent=null;this._children=[];return this}for(d=0;d<this._children.length;d++)this._children[d]==a&&this._children.splice(d,1);a._parent=null;return this},origin:function(a,d){if("string"===typeof a)if("centre"===a||"center"===a||-1===a.indexOf(" "))a=this._w/2,d=this._h/2;else{var b=a.split(" ");if("top"===b[0])d=0;else if("bottom"===
b[0])d=this._h;else if("middle"===b[0]||"center"===b[1]||"centre"===b[1])d=this._h/2;"center"===b[1]||"centre"===b[1]||"middle"===b[1]?a=this._w/2:"left"===b[1]?a=0:"right"===b[1]&&(a=this._w)}this._origin.x=a;this._origin.y=d;return this},flip:function(a){a=a||"X";this["_flip"+a]||(this["_flip"+a]=!0,this.trigger("Change"))},unflip:function(a){a=a||"X";this["_flip"+a]&&(this["_flip"+a]=!1,this.trigger("Change"))},rotate:function(a){this._origin.x=a.o.x-this._x;this._origin.y=a.o.y-this._y;this._attr("_rotation",
a.theta)},_attr:function(a,d){var c=this.pos(),c=this.mbr()||c;if("_rotation"===a)this._rotate(d),this.trigger("Rotate");else if("_z"===a)this._globalZ=parseInt(d+b.zeroFill(this[0],5),10),this.trigger("reorder");else if("_x"==a||"_y"===a||"_w"===a||"_h"===a){var e=this._mbr;e&&(e[a]-=this[a]-d);this[a]=d;this.trigger("Move",c)}this[a]=d;this.trigger("Change",c)}});b.c("Physics",{_gravity:0.4,_friction:0.2,_bounce:0.5,gravity:function(a){this._gravity=a}});b.c("Gravity",{_gravityConst:0.2,_gy:0,_falling:!0,
_anti:null,init:function(){this.requires("2D")},gravity:function(a){a&&(this._anti=a);this.bind("EnterFrame",this._enterFrame);return this},gravityConst:function(a){this._gravityConst=a;return this},_enterFrame:function(){this._falling?(this._gy+=this._gravityConst,this.y+=this._gy):this._gy=0;var a,d=!1,c=this.pos(),e,f=0,i;c._y++;c.x=c._x;c.y=c._y;c.w=c._w;c.h=c._h;e=b.map.search(c);for(i=e.length;f<i;++f)if(a=e[f],a!==this&&a.has(this._anti)&&a.intersect(c)){d=a;break}d?this._falling&&this.stopFalling(d):
this._falling=!0},stopFalling:function(a){a&&(this.y=a._y-this._h);this._falling=!1;this._up&&(this._up=!1);this.trigger("hit")},antigravity:function(){this.unbind("EnterFrame",this._enterFrame)}});b.polygon=function(a){1<arguments.length&&(a=Array.prototype.slice.call(arguments,0));this.points=a};b.polygon.prototype={containsPoint:function(a,b){var c=this.points,e,f,i=!1;e=0;for(f=c.length-1;e<c.length;f=e++)c[e][1]>b!=c[f][1]>b&&a<(c[f][0]-c[e][0])*(b-c[e][1])/(c[f][1]-c[e][1])+c[e][0]&&(i=!i);
return i},shift:function(a,b){for(var c=0,e=this.points.length,f;c<e;c++)f=this.points[c],f[0]+=a,f[1]+=b},rotate:function(a){for(var b=0,c=this.points.length,e,f,i;b<c;b++)e=this.points[b],f=a.o.x+(e[0]-a.o.x)*a.cos+(e[1]-a.o.y)*a.sin,i=a.o.y-(e[0]-a.o.x)*a.sin+(e[1]-a.o.y)*a.cos,e[0]=f,e[1]=i}};b.circle=function(a,b,c){this.x=a;this.y=b;this.radius=c;this.points=[];for(b=0;8>b;b++)a=b*Math.PI/4,this.points[b]=[Math.sin(a)*c,Math.cos(a)*c]};b.circle.prototype={containsPoint:function(a,b){var c=this.radius,
e=this.x-a,f=this.y-b;return e*e+f*f<c*c},shift:function(a,b){this.x+=a;this.y+=b;for(var c=0,e=this.points.length,f;c<e;c++)f=this.points[c],f[0]+=a,f[1]+=b},rotate:function(){}};b.matrix=function(a){this.mtx=a;this.width=a[0].length;this.height=a.length};b.matrix.prototype={x:function(a){if(this.width==a.height){for(var d=[],c=0;c<this.height;c++){d[c]=[];for(var e=0;e<a.width;e++){for(var f=0,i=0;i<this.width;i++)f+=this.mtx[c][i]*a.mtx[i][e];d[c][e]=f}}return new b.matrix(d)}},e:function(a,b){return 1>
a||a>this.mtx.length||1>b||b>this.mtx[0].length?null:this.mtx[a-1][b-1]}};b.c("Collision",{init:function(){this.requires("2D");var a=this._mbr||this;this.map=poly=new b.polygon([0,0],[a._w,0],[a._w,a._h],[0,a._h]);this.attach(this.map);this.map.shift(a._x,a._y)},collision:function(a){var d=this._mbr||this;if(!a)return this;if(1<arguments.length)var c=Array.prototype.slice.call(arguments,0),a=new b.polygon(c);this.map=a;this.attach(this.map);this.map.shift(d._x,d._y);return this},hit:function(a){var d=
this._mbr||this,c=b.map.search(d,!1),e=0,f=c.length,i={},h,m,k,g,q="map"in this&&"containsPoint"in this.map,r=[];if(!f)return!1;for(;e<f;++e)m=c[e],k=m._mbr||m,m&&(h=m[0],!i[h]&&(this[0]!==h&&m.__c[a]&&k._x<d._x+d._w&&k._x+k._w>d._x&&k._y<d._y+d._h&&k._h+k._y>d._y)&&(i[h]=m));for(g in i)m=i[g],q&&"map"in m?(a=this._SAT(this.map,m.map),a.obj=m,a.type="SAT",a&&r.push(a)):r.push({obj:m,type:"MBR"});return!r.length?!1:r},onHit:function(a,b,c){var e=!1;this.bind("EnterFrame",function(){var f=this.hit(a);
f?(e=!0,b.call(this,f)):e&&("function"==typeof c&&c.call(this),e=!1)});return this},_SAT:function(a,b){for(var c=a.points,e=b.points,f=0,i=c.length,h,m=e.length,k=0,g=0,q,r,w,A,E=null,n=null,o=null,y;f<i;f++){g=c[f==i-1?0:f+1];h=c[f];k=-(g[1]-h[1]);g=g[0]-h[0];h=Math.sqrt(k*k+g*g);k/=h;g/=h;w=A=q=r=-1;for(h=0;h<i;++h){y=c[h][0]*k+c[h][1]*g;if(y>w||-1===w)w=y;if(y<q||-1===q)q=y}for(h=0;h<m;++h){y=e[h][0]*k+e[h][1]*g;if(y>A||-1===A)A=y;if(y<r||-1===r)r=y}q<r?(h=r-w,k=-k,g=-g):h=q-A;if(0<=h)return!1;
if(null===E||h>E)E=h,o={x:k,y:g}}for(f=0;f<m;f++){g=e[f==m-1?0:f+1];h=e[f];k=-(g[1]-h[1]);g=g[0]-h[0];h=Math.sqrt(k*k+g*g);k/=h;g/=h;w=A=q=r=-1;for(h=0;h<i;++h){y=c[h][0]*k+c[h][1]*g;if(y>w||-1===w)w=y;if(y<q||-1===q)q=y}for(h=0;h<m;++h){y=e[h][0]*k+e[h][1]*g;if(y>A||-1===A)A=y;if(y<r||-1===r)r=y}q<r?(h=r-w,k=-k,g=-g):h=q-A;if(0<=h)return!1;if(null===E||h>E)E=h;if(h>n||null===n)n=h,o={x:k,y:g}}return{overlap:n,normal:o}}});b.c("WiredHitBox",{init:function(){if(b.support.canvas){var a=n.getElementById("HitBox");
a||(a=n.createElement("canvas"),a.id="HitBox",a.width=b.viewport.width,a.height=b.viewport.height,a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.zIndex="1000",b.stage.elem.appendChild(a));var d=a.getContext("2d"),c=0,e=b("WiredHitBox").length;this.requires("Collision").bind("EnterFrame",function(){if(c==e){d.clearRect(0,0,b.viewport.width,b.viewport.height);c=0}d.beginPath();for(var a in this.map.points)d.lineTo(b.viewport.x+this.map.points[a][0],b.viewport.y+this.map.points[a][1]);
d.closePath();d.stroke();c++})}return this}});b.c("SolidHitBox",{init:function(){if(b.support.canvas){var a=n.getElementById("HitBox");a||(a=n.createElement("canvas"),a.id="HitBox",a.width=b.viewport.width,a.height=b.viewport.height,a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.zIndex="1000",b.stage.elem.appendChild(a));var d=a.getContext("2d"),c=0,e=b("SolidHitBox").length;this.requires("Collision").bind("EnterFrame",function(){if(c==e){d.clearRect(0,0,b.viewport.width,
b.viewport.height);c=0}d.beginPath();for(var a in this.map.points)d.lineTo(b.viewport.x+this.map.points[a][0],b.viewport.y+this.map.points[a][1]);d.closePath();d.fill();c++})}return this}});b.c("DOM",{_element:null,init:function(){function a(){var a=0,b=this.__c,e="";for(a in b)e+=" "+a;e=e.substr(1);this._element.className=e}this._element=n.createElement("div");b.stage.inner.appendChild(this._element);this._element.style.position="absolute";this._element.id="ent"+this[0];this.bind("Change",function(){this._changed||
(this._changed=!0,b.DrawManager.add(this))});this.bind("NewComponent",a).bind("RemoveComponent",a);"ms"===b.support.prefix&&9>b.support.version&&(this._filters={},this.bind("Rotate",function(a){var b=a.matrix,a=b.M11.toFixed(8),e=b.M12.toFixed(8),f=b.M21.toFixed(8),b=b.M22.toFixed(8);this._filters.rotation="progid:DXImageTransform.Microsoft.Matrix(M11="+a+", M12="+e+", M21="+f+", M22="+b+",sizingMethod='auto expand')"}));this.bind("Remove",this.undraw);this.bind("RemoveComponent",function(a){a===
"DOM"&&this.undraw()})},getDomId:function(){return this._element.id},DOM:function(a){a&&a.nodeType&&(this.undraw(),this._element=a,this._element.style.position="absolute");return this},draw:function(){var a=this._element.style,d=this.__coord||[0,0,0,0],d={x:d[0],y:d[1]},c=b.support.prefix,e=[];a.visibility=this._visible?"visible":"hidden";b.support.css3dtransform?e.push("translate3d("+~~this._x+"px,"+~~this._y+"px,0)"):(a.left=~~this._x+"px",a.top=~~this._y+"px");a.width=~~this._w+"px";a.height=~~this._h+
"px";a.zIndex=this._z;a.opacity=this._alpha;a[c+"Opacity"]=this._alpha;"ms"===c&&9>b.support.version&&(this._filters.alpha=8===b.support.version?"progid:DXImageTransform.Microsoft.Alpha(Opacity="+100*this._alpha+")":"alpha(opacity="+100*this._alpha+")");if(this._mbr){var f=this._origin.x+"px "+this._origin.y+"px";a.transformOrigin=f;a[c+"TransformOrigin"]=f;b.support.css3dtransform?e.push("rotateZ("+this._rotation+"deg)"):e.push("rotate("+this._rotation+"deg)")}this._flipX&&(e.push("scaleX(-1)"),
"ms"===c&&9>b.support.version&&(this._filters.flipX="fliph"));this._flipY&&(e.push("scaleY(-1)"),"ms"===c&&9>b.support.version&&(this._filters.flipY="flipv"));"ms"===c&&9>b.support.version&&this.applyFilters();a.transform=e.join(" ");a[c+"Transform"]=e.join(" ");this.trigger("Draw",{style:a,type:"DOM",co:d});return this},applyFilters:function(){var a=this._element.style.filter="",b;for(b in this._filters)this._filters.hasOwnProperty(b)&&(a+=this._filters[b]+" ");this._element.style.filter=a},undraw:function(){this._element&&
b.stage.inner.removeChild(this._element);return this},css:function(a,d){var c,e=this._element,f=e.style;if("object"===typeof a)for(c in a)a.hasOwnProperty(c)&&(e=a[c],"number"===typeof e&&(e+="px"),f[b.DOM.camelize(c)]=e);else if(d)"number"===typeof d&&(d+="px"),f[b.DOM.camelize(a)]=d;else return b.DOM.getStyle(e,a);this.trigger("Change");return this}});try{n.execCommand("BackgroundImageCache",!1,!0)}catch(v){}b.extend({DOM:{window:{init:function(){this.width=g.innerWidth||g.document.documentElement.clientWidth||
g.document.body.clientWidth;this.height=g.innerHeight||g.document.documentElement.clientHeight||g.document.body.clientHeight},width:0,height:0},inner:function(a){var b=a.getBoundingClientRect(),c=b.left+(g.pageXOffset?g.pageXOffset:n.body.scrollLeft),b=b.top+(g.pageYOffset?g.pageYOffset:n.body.scrollTop),e=parseInt(this.getStyle(a,"border-left-width")||0,10)||parseInt(this.getStyle(a,"borderLeftWidth")||0,10)||0,a=parseInt(this.getStyle(a,"border-top-width")||0,10)||parseInt(this.getStyle(a,"borderTopWidth")||
0,10)||0;return{x:c+e,y:b+a}},getStyle:function(a,b){var c;a.currentStyle?c=a.currentStyle[this.camelize(b)]:g.getComputedStyle&&(c=n.defaultView.getComputedStyle(a,null).getPropertyValue(this.csselize(b)));return c},camelize:function(a){return a.replace(/-+(.)?/g,function(a,b){return b?b.toUpperCase():""})},csselize:function(a){return a.replace(/[A-Z]/g,function(a){return a?"-"+a.toLowerCase():""})},translate:function(a,d){return{x:(a-b.stage.x+n.body.scrollLeft+n.documentElement.scrollLeft-b.viewport._x)/
b.viewport._zoom,y:(d-b.stage.y+n.body.scrollTop+n.documentElement.scrollTop-b.viewport._y)/b.viewport._zoom}}}});b.c("HTML",{inner:"",init:function(){this.requires("2D, DOM")},replace:function(a){this.inner=a;this._element.innerHTML=a;return this},append:function(a){this.inner+=a;this._element.innerHTML+=a;return this},prepend:function(a){this.inner=a+this.inner;this._element.innerHTML=a+this.inner;return this}});b.storage=function(){function a(d){if(d.c)return b.e(d.c).attr(d.attr).trigger("LoadData",
d,a);if("object"==typeof d)for(var c in d)d[c]=a(d[c]);return d}function d(b){if("string"!=typeof b)return null;b=JSON?JSON.parse(b):eval("("+b+")");return a(b)}function c(a){if(a.__c){var b={c:[],attr:{}};a.trigger("SaveData",b,c);for(var d in a.__c)b.c.push(d);b.c=b.c.join(", ");a=b}else if("object"==typeof a)for(b in a)a[b]=c(a[b]);return a}function e(a){if(JSON)return a=c(a),JSON.stringify(a);alert("Crafty does not support saving on your browser. Please upgrade to a newer browser.");return!1}
function f(a){p=a}function i(){"undefined"!=typeof p&&(xhr.open("POST",p),xhr.onreadystatechange=function(){if(4==xhr.readyState&&200==xhr.status){var a=eval("("+xhr.responseText+")"),d;for(d in a)b.storage.check(a[d].key,a[d].timestamp)&&m(a[d].key)}},xhr.send("mode=timestamps&game="+q))}function h(a,b,d){if("undefined"!=typeof p){var c=new XMLHttpRequest;c.open("POST",p);c.send("mode=save&key="+a+"&data="+encodeURIComponent(b)+"&ts="+d+"&game="+q)}}function m(a){if("undefined"!=typeof p){var d=
new XMLHttpRequest;d.open("POST",p);d.onreadystatechange=function(){if(4==d.readyState&&200==d.status){var c=eval("("+d.responseText+")");b.storage.save(a,"save",c)}};d.send("mode=load&key="+a+"&game="+q)}}var k=null,p,q,r={};if("object"!=typeof indexedDB&&("object"==typeof mozIndexedDB&&(g.indexedDB=mozIndexedDB),"object"==typeof webkitIndexedDB))g.indexedDB=webkitIndexedDB,g.IDBTransaction=webkitIDBTransaction;return"object"==typeof indexedDB?{open:function(a){function b(){try{k.transaction(["save"],
IDBTransaction.READ).objectStore("save").getAll().onsuccess=function(){for(var a=0,b=event.target.result,d=b.length;a<d;a++)r[b[a].key]=b[a].timestamp}}catch(a){}}function d(){k.setVersion("1.0").onsuccess=function(){for(var a=0;a<c.length;a++){var b=c[a];k.objectStoreNames.contains(b)||k.createObjectStore(b,{keyPath:"key"})}}}q=a;var c=[];1!=arguments.length&&(c=arguments,c.shift());c.push("save");c.push("cache");null==k?indexedDB.open(q,"Database for "+q).onsuccess=function(a){k=a.target.result;
d();b();i()}:(d(),b(),i())},save:function(a,d,c){if(null==k)setTimeout(function(){b.storage.save(a,d,c)},1);else{var f=e(c),i=(new Date).getTime();"save"==d&&h(a,f,i);try{k.transaction([d],IDBTransaction.READ_WRITE).objectStore(d).put({data:f,timestamp:i,key:a})}catch(g){console.error(g)}}},load:function(a,c,e){if(null==k)setTimeout(function(){b.storage.load(a,c,e)},1);else try{k.transaction([c],IDBTransaction.READ).objectStore(c).get(a).onsuccess=function(a){e(d(a.target.result.data))}}catch(f){console.error(f)}},
getAllKeys:function(a,d){null==k&&setTimeout(function(){b.storage.getAllkeys(a,d)},1);try{var c=[];k.transaction([a],IDBTransaction.READ).objectStore(a).getCursor().onsuccess=function(a){(a=a.target.result)?(c.push(a.key),a["continue"]()):d(c)}}catch(e){console.error(e)}},check:function(a,b){return r[a]>b},external:f}:"function"==typeof openDatabase?{open:function(a){q=a;if(1==arguments.length)k={save:openDatabase(a+"_save","1.0","Saves games for "+a,5242880),cache:openDatabase(a+"_cache","1.0","Cache for "+
a,5242880)};else{var b=arguments,d=0;for(b.shift();d<b.length;d++)"undefined"==typeof k[b[d]]&&(k[b[d]]=openDatabase(q+"_"+b[d],"1.0",type,5242880))}k.save.transaction(function(a){a.executeSql("SELECT key, timestamp FROM data",[],function(a,b){for(var d=0,c=b.rows,e=c.length;d<e;d++)r[c.item(d).key]=c.item(d).timestamp})})},save:function(a,b,d){"undefined"==typeof k[b]&&""!=q&&this.open(q,b);var c=e(d),f=(new Date).getTime();"save"==b&&h(a,c,f);k[b].transaction(function(b){b.executeSql("CREATE TABLE IF NOT EXISTS data (key unique, text, timestamp)");
b.executeSql("SELECT * FROM data WHERE key = ?",[a],function(b,d){d.rows.length?b.executeSql("UPDATE data SET text = ?, timestamp = ? WHERE key = ?",[c,f,a]):b.executeSql("INSERT INTO data VALUES (?, ?, ?)",[a,c,f])})})},load:function(a,c,e){null==k[c]?setTimeout(function(){b.storage.load(a,c,e)},1):k[c].transaction(function(b){b.executeSql("SELECT text FROM data WHERE key = ?",[a],function(a,b){b.rows.length&&(res=d(b.rows.item(0).text),e(res))})})},getAllKeys:function(a,d){null==k[a]?setTimeout(function(){b.storage.getAllKeys(a,
d)},1):k[a].transaction(function(a){a.executeSql("SELECT key FROM data",[],function(a,b){d(b.rows)})})},check:function(a,b){return r[a]>b},external:f}:"object"==typeof g.localStorage?{open:function(a){q=a},save:function(a,b,d){var c=q+"."+b+"."+a,d=e(d),f=(new Date).getTime();"save"==b&&h(a,d,f);g.localStorage[c]=d;"save"==b&&(g.localStorage[c+".ts"]=f)},load:function(a,b,c){c(d(g.localStorage[q+"."+b+"."+a]))},getAllKeys:function(a,b){var d={},c=[],e=q+"."+a,f;for(f in g.localStorage)if(-1!=f.indexOf(e)){var h=
f.replace(e,"").replace(".ts","");d[h]=!0}for(f in d)c.push(f);b(c)},check:function(a,b){var d=g.localStorage[q+".save."+a+".ts"];return parseInt(b)>parseInt(d)},external:f}:{open:function(a){q=a},save:function(a,b,d){if("save"==b){var d=e(d),c=(new Date).getTime();"save"==b&&h(a,d,c);n.cookie=q+"_"+a+"="+d+"; "+q+"_"+a+"_ts="+c+"; expires=Thur, 31 Dec 2099 23:59:59 UTC; path=/"}},load:function(a,b,c){"save"==b&&(b=RegExp(q+"_"+a+"=[^;]*").exec(n.cookie),a=d(b[0].replace(q+"_"+a+"=","")),c(a))},getAllKeys:function(a,
b){if("save"==a){for(var d=RegExp(q+"_[^_=]","g").exec(n.cookie),c=0,e=d.length,f={},h=[];c<e;c++){var i=d[c].replace(q+"_","");f[i]=!0}for(c in f)h.push(c);b(h)}},check:function(a,b){var d=q+"_"+a+"_ts",d=RegExp(d+"=[^;]").exec(n.cookie)[0].replace(d+"=","");return parseInt(b)>parseInt(d)},external:f}}();(function(){var a=b.support={},d=navigator.userAgent.toLowerCase(),c=/(webkit)[ \/]([\w.]+)/.exec(d)||/(o)pera(?:.*version)?[ \/]([\w.]+)/.exec(d)||/(ms)ie ([\w.]+)/.exec(d)||/(moz)illa(?:.*? rv:([\w.]+))?/.exec(d)||
[];if(d=/iPad|iPod|iPhone|Android|webOS|IEMobile/i.exec(d))b.mobile=d[0];a.setter="__defineSetter__"in this&&"__defineGetter__"in this;a.defineProperty=function(){if(!1 in Object)return!1;try{Object.defineProperty({},"x",{})}catch(a){return!1}return!0}();a.audio="Audio"in g;a.prefix=c[1]||c[0];"moz"===a.prefix&&(a.prefix="Moz");"o"===a.prefix&&(a.prefix="O");c[2]&&(a.versionName=c[2],a.version=+c[2].split(".")[0]);a.canvas="getContext"in n.createElement("canvas");if(a.canvas){var e;try{e=n.createElement("canvas").getContext("experimental-webgl"),
e.viewportWidth=canvas.width,e.viewportHeight=canvas.height}catch(f){}a.webgl=!!e}else a.webgl=!1;a.css3dtransform="undefined"!==typeof n.createElement("div").style.Perspective||"undefined"!==typeof n.createElement("div").style[a.prefix+"Perspective"];a.deviceorientation="undefined"!==typeof g.DeviceOrientationEvent||"undefined"!==typeof g.OrientationEvent;a.devicemotion="undefined"!==typeof g.DeviceMotionEvent})();b.extend({zeroFill:function(a,b){b-=a.toString().length;return 0<b?Array(b+(/\./.test(a)?
2:1)).join("0")+a:a.toString()},sprite:function(a,d,c,e,f,i){var h,g,k,p,q,r;"string"===typeof a&&(i=f,f=e,e=d,c=a,d=a=1);"string"==typeof d&&(i=f,f=e,e=c,c=d,d=a);!i&&f&&(i=f);f=parseInt(f||0,10);i=parseInt(i||0,10);r=b.asset(c);r||(r=new Image,r.src=c,b.asset(c,r),r.onload=function(){for(h in e)b(h).each(function(){this.ready=true;this.trigger("Change")})});for(h in e)e.hasOwnProperty(h)&&(g=e[h],k=g[0]*(a+f),p=g[1]*(d+i),q=g[2]*a||a,g=g[3]*d||d,b.c(h,{ready:!1,__coord:[k,p,q,g],init:function(){this.requires("Sprite");
this.__trim=[0,0,0,0];this.__image=c;this.__coord=[this.__coord[0],this.__coord[1],this.__coord[2],this.__coord[3]];this.__tile=a;this.__tileh=d;this.__padding=[f,i];this.img=r;if(this.img.complete&&this.img.width>0){this.ready=true;this.trigger("Change")}this.w=this.__coord[2];this.h=this.__coord[3]}}));return this},_events:{},addEvent:function(a,b,c,e){3===arguments.length&&(e=c,c=b,b=g.document);var f=function(b){b=b||g.event;typeof e==="function"&&e.call(a,b)},i=a[0]||"";this._events[i+b+c+e]||
(this._events[i+b+c+e]=f,b.attachEvent?b.attachEvent("on"+c,f):b.addEventListener(c,f,!1))},removeEvent:function(a,b,c,e){3===arguments.length&&(e=c,c=b,b=g.document);var f=a[0]||"",i=this._events[f+b+c+e];i&&(b.detachEvent?b.detachEvent("on"+c,i):b.removeEventListener(c,i,!1),delete this._events[f+b+c+e])},background:function(a){b.stage.elem.style.background=a},viewport:{clampToEntities:!0,width:0,height:0,_x:0,_y:0,scroll:function(a,d){var d=Math.floor(d),c=d-this[a],e=b.canvas.context,f=b.stage.inner.style;
this[a]=d;"_x"==a?e&&e.translate(c,0):e&&e.translate(0,c);e&&b.DrawManager.drawAll();f["_x"==a?"left":"top"]=d+"px"},rect:function(){return{_x:-this._x,_y:-this._y,_w:this.width,_h:this.height}},pan:function(){function a(){var a=0;for(c in d){var e=d[c];0<e.remTime?(e.current+=e.diff,e.remTime--,b.viewport[c]=Math.floor(e.current),a++):delete d[c]}a&&b.viewport._clamp()}var d={},c,e=!1;return function(f,i,h){b.viewport.follow();if("reset"==f)for(c in d)d[c].remTime=0;else 0==h&&(h=1),d[f]={diff:-i/
h,current:b.viewport[f],remTime:h},e||(b.bind("EnterFrame",a),e=!0)}}(),follow:function(){function a(){b.viewport.scroll("_x",-(this.x+this.w/2-b.viewport.width/2-c));b.viewport.scroll("_y",-(this.y+this.h/2-b.viewport.height/2-e));b.viewport._clamp()}var d,c,e;return function(f,i,h){d&&d.unbind("Change",a);f&&f.has("2D")&&(b.viewport.pan("reset"),d=f,c="undefined"!=typeof i?i:0,e="undefined"!=typeof h?h:0,f.bind("Change",a),a.call(f))}}(),centerOn:function(a,d){var c=a.x+a.w/2-b.viewport.width/2,
e=a.y+a.h/2-b.viewport.height/2;b.viewport.pan("reset");b.viewport.pan("x",c,d);b.viewport.pan("y",e,d)},_zoom:1,zoom:function(){function a(){if(0<e){var a=h.width*d,i=h.height*d;this._zoom=d+=c;a=h.width*d-a;i=h.height*d-i;b.stage.inner.style[f]="scale("+d+","+d+")";b.canvas._canvas&&(b.canvas.context.scale(d,d),b.DrawManager.drawAll());b.viewport.x-=a*g.width;b.viewport.y-=i*g.height;e--}}var d=1,c=0,e=0,f=b.support.prefix+"Transform",i=!1,h={},g={};return function(f,p,q,r){var n=b.map.boundaries(),
f=f?d*f:1;h.width=n.max.x-n.min.x;h.height=n.max.y-n.min.y;g.width=p/h.width;g.height=q/h.height;0==r&&(r=1);c=(f-d)/r;e=r;b.viewport.pan("reset");i||(b.bind("EnterFrame",a),i=!0)}}(),scale:function(){var a=b.support.prefix+"Transform",d,c;return function(e){var f=b.map.boundaries();this._zoom=e=e?this._zoom*e:1;d=f.max.x-f.min.x;c=f.max.y-f.min.y;f=d*e;e*=c;b.viewport.pan("reset");b.stage.inner.style[a]="scale("+this._zoom+","+this._zoom+")";b.stage.elem.style.width=f+"px";b.stage.elem.style.height=
e+"px";b.canvas._canvas&&(b.canvas._canvas.width=f,b.canvas._canvas.height=e,b.canvas.context.scale(this._zoom,this._zoom),b.DrawManager.drawAll());b.viewport.width=f;b.viewport.height=e}}(),mouselook:function(){var a=!1,d=!1,c={};old={};return function(e,f){if("boolean"==typeof e)(a=e)?b.mouseObjs++:b.mouseObjs=Math.max(0,b.mouseObjs-1);else if(a)switch(e){case "move":case "drag":if(!d)break;diff={x:f.clientX-c.x,y:f.clientY-c.y};b.viewport.x+=diff.x;b.viewport.y+=diff.y;b.viewport._clamp();case "start":c.x=
f.clientX;c.y=f.clientY;d=!0;break;case "stop":d=!1}}}(),_clamp:function(){if(this.clampToEntities){var a=b.map.boundaries();a.max.x-a.min.x>b.viewport.width?(a.max.x-=b.viewport.width,b.viewport.x<-a.max.x?b.viewport.x=-a.max.x:b.viewport.x>-a.min.x&&(b.viewport.x=-a.min.x)):b.viewport.x=-1*(a.min.x+(a.max.x-a.min.x)/2-b.viewport.width/2);a.max.y-a.min.y>b.viewport.height?(a.max.y-=b.viewport.height,b.viewport.y<-a.max.y?b.viewport.y=-a.max.y:b.viewport.y>-a.min.y&&(b.viewport.y=-a.min.y)):b.viewport.y=
-1*(a.min.y+(a.max.y-a.min.y)/2-b.viewport.height/2)}},init:function(a,d){b.DOM.window.init();this.width=!a||b.mobile?b.DOM.window.width:a;this.height=!d||b.mobile?b.DOM.window.height:d;var c=n.getElementById("cr-stage");b.stage={x:0,y:0,fullscreen:!1,elem:c?c:n.createElement("div"),inner:n.createElement("div")};if(!a&&!d||b.mobile)n.body.style.overflow="hidden",b.stage.fullscreen=!0;b.addEvent(this,g,"resize",b.viewport.reload);b.addEvent(this,g,"blur",function(){b.settings.get("autoPause")&&b.pause()});
b.addEvent(this,g,"focus",function(){b._paused&&b.settings.get("autoPause")&&b.pause()});b.settings.register("stageSelectable",function(a){b.stage.elem.onselectstart=a?function(){return!0}:function(){return!1}});b.settings.modify("stageSelectable",!1);b.settings.register("stageContextMenu",function(a){b.stage.elem.oncontextmenu=a?function(){return!0}:function(){return!1}});b.settings.modify("stageContextMenu",!1);b.settings.register("autoPause",function(){});b.settings.modify("autoPause",!1);c||(n.body.appendChild(b.stage.elem),
b.stage.elem.id="cr-stage");c=b.stage.elem.style;b.stage.elem.appendChild(b.stage.inner);b.stage.inner.style.position="absolute";b.stage.inner.style.zIndex="1";c.width=this.width+"px";c.height=this.height+"px";c.overflow="hidden";if(b.mobile){c.position="absolute";c.left="0px";c.top="0px";var c=n.createElement("meta"),e=n.getElementsByTagName("HEAD")[0];c.setAttribute("name","viewport");c.setAttribute("content","width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no");e.appendChild(c);
c=n.createElement("meta");c.setAttribute("name","apple-mobile-web-app-capable");c.setAttribute("content","yes");e.appendChild(c);setTimeout(function(){g.scrollTo(0,1)},0);b.addEvent(this,g,"touchmove",function(a){a.preventDefault()});b.stage.x=0;b.stage.y=0}else c.position="relative",c=b.DOM.inner(b.stage.elem),b.stage.x=c.x,b.stage.y=c.y;b.support.setter?(this.__defineSetter__("x",function(a){this.scroll("_x",a)}),this.__defineSetter__("y",function(a){this.scroll("_y",a)}),this.__defineGetter__("x",
function(){return this._x}),this.__defineGetter__("y",function(){return this._y})):b.support.defineProperty?(Object.defineProperty(this,"x",{set:function(a){this.scroll("_x",a)},get:function(){return this._x}}),Object.defineProperty(this,"y",{set:function(a){this.scroll("_y",a)},get:function(){return this._y}})):(this.x=this._x,this.y=this._y,b.e("viewport"))},reload:function(){b.DOM.window.init();var a=b.DOM.window.width,d=b.DOM.window.height;b.stage.fullscreen&&(this.width=a,this.height=d,b.stage.elem.style.width=
a+"px",b.stage.elem.style.height=d+"px",b.canvas._canvas&&(b.canvas._canvas.width=a,b.canvas._canvas.height=d,b.DrawManager.drawAll()));a=b.DOM.inner(b.stage.elem);b.stage.x=a.x;b.stage.y=a.y}},keys:{BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,"0":48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,
P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190},mouseButtons:{LEFT:0,MIDDLE:1,RIGHT:2}});b.c("viewport",{init:function(){this.bind("EnterFrame",function(){b.viewport._x!==
b.viewport.x&&b.viewport.scroll("_x",b.viewport.x);b.viewport._y!==b.viewport.y&&b.viewport.scroll("_y",b.viewport.y)})}});b.extend({device:{_deviceOrientationCallback:!1,_deviceMotionCallback:!1,_normalizeDeviceOrientation:function(a){var d;g.DeviceOrientationEvent?d={tiltLR:a.gamma,tiltFB:a.beta,dir:a.alpha,motUD:null}:g.OrientationEvent&&(d={tiltLR:90*a.x,tiltFB:-90*a.y,dir:null,motUD:a.z});b.device._deviceOrientationCallback(d)},_normalizeDeviceMotion:function(a){var a=a.accelerationIncludingGravity,
d=0<a.z?1:-1,a={acceleration:a,rawAcceleration:"["+Math.round(a.x)+", "+Math.round(a.y)+", "+Math.round(a.z)+"]",facingUp:d,tiltLR:Math.round(-90*(a.x/9.81)),tiltFB:Math.round(90*((a.y+9.81)/9.81)*d)};b.device._deviceMotionCallback(a)},deviceOrientation:function(a){this._deviceOrientationCallback=a;b.support.deviceorientation&&(g.DeviceOrientationEvent?b.addEvent(this,g,"deviceorientation",this._normalizeDeviceOrientation):g.OrientationEvent&&b.addEvent(this,g,"MozOrientation",this._normalizeDeviceOrientation))},
deviceMotion:function(a){this._deviceMotionCallback=a;b.support.devicemotion&&g.DeviceMotionEvent&&b.addEvent(this,g,"devicemotion",this._normalizeDeviceMotion)}}});b.c("Sprite",{__image:"",__tile:0,__tileh:0,__padding:null,__trim:null,img:null,ready:!1,init:function(){this.__trim=[0,0,0,0];var a=function(a){var b=a.co,e=a.pos,f=a.ctx;"canvas"===a.type?f.drawImage(this.img,b.x,b.y,b.w,b.h,e._x,e._y,e._w,e._h):"DOM"===a.type&&(this._element.style.background="url('"+this.__image+"') no-repeat -"+b.x+
"px -"+b.y+"px")};this.bind("Draw",a).bind("RemoveComponent",function(b){"Sprite"===b&&this.unbind("Draw",a)})},sprite:function(a,b,c,e){this.__coord=[a*this.__tile+this.__padding[0]+this.__trim[0],b*this.__tileh+this.__padding[1]+this.__trim[1],this.__trim[2]||c*this.__tile||this.__tile,this.__trim[3]||e*this.__tileh||this.__tileh];this.trigger("Change");return this},crop:function(a,b,c,e){var f=this._mbr||this.pos();this.__trim=[];this.__trim[0]=a;this.__trim[1]=b;this.__trim[2]=c;this.__trim[3]=
e;this.__coord[0]+=a;this.__coord[1]+=b;this.__coord[2]=c;this.__coord[3]=e;this._w=c;this._h=e;this.trigger("Change",f);return this}});b.c("Canvas",{init:function(){b.canvas.context||b.canvas.init();b.DrawManager.total2D++;this.bind("Change",function(a){!1===this._changed?this._changed=b.DrawManager.add(a||this,this):a&&(this._changed=b.DrawManager.add(a,this))});this.bind("Remove",function(){b.DrawManager.total2D--;b.DrawManager.add(this,this)})},draw:function(a,d,c,e,f){if(this.ready){4===arguments.length&&
(f=e,e=c,c=d,d=a,a=b.canvas.context);var i={_x:this._x+(d||0),_y:this._y+(c||0),_w:e||this._w,_h:f||this._h},h=a||b.canvas.context,g=this.__coord||[0,0,0,0],g={x:g[0]+(d||0),y:g[1]+(c||0),w:e||g[2],h:f||g[3]};this._mbr&&(h.save(),h.translate(this._origin.x+this._x,this._origin.y+this._y),i._x=-this._origin.x,i._y=-this._origin.y,h.rotate(this._rotation%360*(Math.PI/180)));if(this._flipX||this._flipY)if(h.save(),h.scale(this._flipX?-1:1,this._flipY?-1:1),this._flipX&&(i._x=-(i._x+i._w)),this._flipY)i._y=
-(i._y+i._h);if(1>this._alpha){var k=h.globalAlpha;h.globalAlpha=this._alpha}this.trigger("Draw",{type:"canvas",pos:i,co:g,ctx:h});(this._mbr||this._flipX||this._flipY)&&h.restore();k&&(h.globalAlpha=k);return this}}});b.extend({canvas:{context:null,init:function(){if(b.support.canvas){var a;a=n.createElement("canvas");a.width=b.viewport.width;a.height=b.viewport.height;a.style.position="absolute";a.style.left="0px";a.style.top="0px";b.stage.elem.appendChild(a);b.canvas.context=a.getContext("2d");
b.canvas._canvas=a}else b.trigger("NoCanvas"),b.stop()}}});b.extend({over:null,mouseObjs:0,mousePos:{},lastEvent:null,keydown:{},selected:!1,detectBlur:function(a){a=a.clientX>b.stage.x&&a.clientX<b.stage.x+b.viewport.width&&a.clientY>b.stage.y&&a.clientY<b.stage.y+b.viewport.height;!b.selected&&a&&b.trigger("CraftyFocus");b.selected&&!a&&b.trigger("CraftyBlur");b.selected=a},mouseDispatch:function(a){if(b.mouseObjs){b.lastEvent=a;var d=-1,c,e,f=0,i,h=b.DOM.translate(a.clientX,a.clientY),g,k={};e=
a.target?a.target:a.srcElement;var p=a.type;a.mouseButton=null==a.which?2>a.button?b.mouseButtons.LEFT:4==a.button?b.mouseButtons.MIDDLE:b.mouseButtons.RIGHT:2>a.which?b.mouseButtons.LEFT:2==a.which?b.mouseButtons.MIDDLE:b.mouseButtons.RIGHT;a.realX=g=b.mousePos.x=h.x;a.realY=h=b.mousePos.y=h.y;if("CANVAS"!=e.nodeName){for(;"string"!=typeof e.id&&-1==e.id.indexOf("ent");)e=e.parentNode;ent=b(parseInt(e.id.replace("ent","")));ent.has("Mouse")&&ent.isAt(g,h)&&(c=ent)}if(!c){e=b.map.search({_x:g,_y:h,
_w:1,_h:1},!1);for(i=e.length;f<i;++f)if(e[f].__c.Mouse&&e[f]._visible){var q=e[f],n=!1;if(!k[q[0]]&&(k[q[0]]=!0,q.mapArea?q.mapArea.containsPoint(g,h)&&(n=!0):q.isAt(g,h)&&(n=!0),n&&(q._z>=d||-1===d)&&!(q._z===d&&q[0]<c[0])))d=q._z,c=q}}c?"mousedown"===p?c.trigger("MouseDown",a):"mouseup"===p?c.trigger("MouseUp",a):"dblclick"==p?c.trigger("DoubleClick",a):"click"==p?c.trigger("Click",a):"mousemove"===p?(c.trigger("MouseMove",a),this.over!==c&&(this.over&&(this.over.trigger("MouseOut",a),this.over=
null),this.over=c,c.trigger("MouseOver",a))):c.trigger(p,a):("mousemove"===p&&this.over&&(this.over.trigger("MouseOut",a),this.over=null),"mousedown"===p?b.viewport.mouselook("start",a):"mousemove"===p?b.viewport.mouselook("drag",a):"mouseup"==p&&b.viewport.mouselook("stop"));"mousemove"===p&&(this.lastEvent=a)}},touchDispatch:function(a){var b;"touchstart"===a.type?b="mousedown":"touchmove"===a.type?b="mousemove":"touchend"===a.type?b="mouseup":"touchcancel"===a.type?b="mouseup":"touchleave"===a.type&&
(b="mouseup");a.touches&&a.touches.length?first=a.touches[0]:a.changedTouches&&a.changedTouches.length&&(first=a.changedTouches[0]);var c=n.createEvent("MouseEvent");c.initMouseEvent(b,!0,!0,g,1,first.screenX,first.screenY,first.clientX,first.clientY,!1,!1,!1,!1,0,a.relatedTarget);first.target.dispatchEvent(c)},keyboardDispatch:function(a){a.key=a.keyCode||a.which;"keydown"===a.type?!0!==b.keydown[a.key]&&(b.keydown[a.key]=!0,b.trigger("KeyDown",a)):"keyup"===a.type&&(delete b.keydown[a.key],b.trigger("KeyUp",
a));if(b.selected&&!(8==a.key||112<=a.key&&135>=a.key))return a.stopPropagation(),a.preventDefault?a.preventDefault():a.returnValue=!1,!1}});b.bind("Load",function(){b.addEvent(this,"keydown",b.keyboardDispatch);b.addEvent(this,"keyup",b.keyboardDispatch);b.addEvent(this,b.stage.elem,"mousedown",b.mouseDispatch);b.addEvent(this,b.stage.elem,"mouseup",b.mouseDispatch);b.addEvent(this,n.body,"mouseup",b.detectBlur);b.addEvent(this,b.stage.elem,"mousemove",b.mouseDispatch);b.addEvent(this,b.stage.elem,
"click",b.mouseDispatch);b.addEvent(this,b.stage.elem,"dblclick",b.mouseDispatch);b.addEvent(this,b.stage.elem,"touchstart",b.touchDispatch);b.addEvent(this,b.stage.elem,"touchmove",b.touchDispatch);b.addEvent(this,b.stage.elem,"touchend",b.touchDispatch);b.addEvent(this,b.stage.elem,"touchcancel",b.touchDispatch);b.addEvent(this,b.stage.elem,"touchleave",b.touchDispatch)});b.c("Mouse",{init:function(){b.mouseObjs++;this.bind("Remove",function(){b.mouseObjs--})},areaMap:function(a){if(1<arguments.length)var d=
Array.prototype.slice.call(arguments,0),a=new b.polygon(d);a.shift(this._x,this._y);this.mapArea=a;this.attach(this.mapArea);return this}});b.c("Draggable",{_origMouseDOMPos:null,_oldX:null,_oldY:null,_dragging:!1,_dir:null,_ondrag:null,_ondown:null,_onup:null,init:function(){this.requires("Mouse");this._ondrag=function(a){var d=b.DOM.translate(a.clientX,a.clientY);if(0==d.x||0==d.y)return!1;this._dir?(d=(d.x-this._origMouseDOMPos.x)*this._dir.x+(d.y-this._origMouseDOMPos.y)*this._dir.y,this.x=this._oldX+
d*this._dir.x,this.y=this._oldY+d*this._dir.y):(this.x=this._oldX+(d.x-this._origMouseDOMPos.x),this.y=this._oldY+(d.y-this._origMouseDOMPos.y));this.trigger("Dragging",a)};this._ondown=function(a){a.mouseButton===b.mouseButtons.LEFT&&(this._origMouseDOMPos=b.DOM.translate(a.clientX,a.clientY),this._oldX=this._x,this._oldY=this._y,this._dragging=!0,b.addEvent(this,b.stage.elem,"mousemove",this._ondrag),b.addEvent(this,b.stage.elem,"mouseup",this._onup),this.trigger("StartDrag",a))};this._onup=function(a){!0==
this._dragging&&(b.removeEvent(this,b.stage.elem,"mousemove",this._ondrag),b.removeEvent(this,b.stage.elem,"mouseup",this._onup),this._dragging=!1,this.trigger("StopDrag",a))};this.enableDrag()},dragDirection:function(a){if("undefined"===typeof a)this._dir=null;else if(""+parseInt(a)==a)this._dir={x:Math.cos(a/180*Math.PI),y:Math.sin(a/180*Math.PI)};else{var b=Math.sqrt(a.x*a.x+a.y*a.y);this._dir={x:a.x/b,y:a.y/b}}},stopDrag:function(){b.removeEvent(this,b.stage.elem,"mousemove",this._ondrag);b.removeEvent(this,
b.stage.elem,"mouseup",this._onup);this._dragging=!1;this.trigger("StopDrag");return this},startDrag:function(){this._dragging||(this._dragging=!0,b.addEvent(this,b.stage.elem,"mousemove",this._ondrag));return this},enableDrag:function(){this.bind("MouseDown",this._ondown);b.addEvent(this,b.stage.elem,"mouseup",this._onup);return this},disableDrag:function(){this.unbind("MouseDown",this._ondown);this.stopDrag();return this}});b.c("Keyboard",{isDown:function(a){"string"===typeof a&&(a=b.keys[a]);return!!b.keydown[a]}});
b.c("Multiway",{_speed:3,_keydown:function(a){this._keys[a.key]&&(this._movement.x=Math.round(1E3*(this._movement.x+this._keys[a.key].x))/1E3,this._movement.y=Math.round(1E3*(this._movement.y+this._keys[a.key].y))/1E3,this.trigger("NewDirection",this._movement))},_keyup:function(a){this._keys[a.key]&&(this._movement.x=Math.round(1E3*(this._movement.x-this._keys[a.key].x))/1E3,this._movement.y=Math.round(1E3*(this._movement.y-this._keys[a.key].y))/1E3,this.trigger("NewDirection",this._movement))},
_enterframe:function(){if(!this.disableControls&&(0!==this._movement.x&&(this.x+=this._movement.x,this.trigger("Moved",{x:this.x-this._movement.x,y:this.y})),0!==this._movement.y))this.y+=this._movement.y,this.trigger("Moved",{x:this.x,y:this.y-this._movement.y})},init:function(){this._keyDirection={};this._keys={};this._movement={x:0,y:0};this._speed={x:3,y:3}},multiway:function(a,d){d?a.x&&a.y?(this._speed.x=a.x,this._speed.y=a.y):(this._speed.x=a,this._speed.y=a):d=a;this._keyDirection=d;this.speed(this._speed);
this.enableControl();for(var c in d)b.keydown[b.keys[c]]&&this.trigger("KeyDown",{key:b.keys[c]});return this},enableControl:function(){this.bind("KeyDown",this._keydown).bind("KeyUp",this._keyup).bind("EnterFrame",this._enterframe);return this},disableControl:function(){this.unbind("KeyDown",this._keydown).unbind("KeyUp",this._keyup).unbind("EnterFrame",this._enterframe);return this},speed:function(a){for(var d in this._keyDirection)this._keys[b.keys[d]||d]={x:Math.round(1E3*Math.cos(this._keyDirection[d]*
(Math.PI/180))*a.x)/1E3,y:Math.round(1E3*Math.sin(this._keyDirection[d]*(Math.PI/180))*a.y)/1E3};return this}});b.c("Fourway",{init:function(){this.requires("Multiway")},fourway:function(a){this.multiway(a,{UP_ARROW:-90,DOWN_ARROW:90,RIGHT_ARROW:0,LEFT_ARROW:180,W:-90,S:90,D:0,A:180,Z:-90,Q:180});return this}});b.c("Twoway",{_speed:3,_up:!1,init:function(){this.requires("Fourway, Keyboard")},twoway:function(a,b){this.multiway(a,{RIGHT_ARROW:0,LEFT_ARROW:180,D:0,A:180,Q:180});a&&(this._speed=a);b=
b||2*this._speed;this.bind("EnterFrame",function(){if(!this.disableControls&&this._up){this.y=this.y-b;this._falling=true}}).bind("KeyDown",function(){if(this.isDown("UP_ARROW")||this.isDown("W")||this.isDown("Z"))this._up=true});return this}});b.c("SpriteAnimation",{_reels:null,_frame:null,_currentReelId:null,init:function(){this._reels={}},animate:function(a,b,c,e){var f,i,h,g,k;if(4>arguments.length&&"number"===typeof b)return this._currentReelId=a,currentReel=this._reels[a],this._frame={currentReel:currentReel,
numberOfFramesBetweenSlides:Math.ceil(b/currentReel.length),currentSlideNumber:0,frameNumberBetweenSlides:0,repeat:0},3===arguments.length&&"number"===typeof c&&(-1===c?this._frame.repeatInfinitly=!0:this._frame.repeat=c),k=this._frame.currentReel[0],this.__coord[0]=k[0],this.__coord[1]=k[1],this.bind("EnterFrame",this.updateSprite),this;if("number"===typeof b){h=this.__tile+parseInt(this.__padding[0]||0,10);g=this.__tileh+parseInt(this.__padding[1]||0,10);f=[];i=b;if(e>b)for(;i<=e;i++)f.push([i*
h,c*g]);else for(;i>=e;i--)f.push([i*h,c*g]);this._reels[a]=f}else if("object"===typeof b){i=0;f=[];e=b.length-1;h=this.__tile+parseInt(this.__padding[0]||0,10);for(g=this.__tileh+parseInt(this.__padding[1]||0,10);i<=e;i++)k=b[i],f.push([k[0]*h,k[1]*g]);this._reels[a]=f}return this},updateSprite:function(){var a=this._frame;if(a){if(this._frame.frameNumberBetweenSlides++===a.numberOfFramesBetweenSlides){var b=a.currentReel[a.currentSlideNumber++];this.__coord[0]=b[0];this.__coord[1]=b[1];this._frame.frameNumberBetweenSlides=
0}if(a.currentSlideNumber===a.currentReel.length)if(!0===this._frame.repeatInfinitly||0<this._frame.repeat)this._frame.repeat&&this._frame.repeat--,this._frame.frameNumberBetweenSlides=0,this._frame.currentSlideNumber=0;else if(this._frame.frameNumberBetweenSlides===a.numberOfFramesBetweenSlides){this.trigger("AnimationEnd",{reel:a.currentReel});this.stop();return}this.trigger("Change")}},stop:function(){this.unbind("EnterFrame",this.updateSprite);this.unbind("AnimationEnd");this._frame=this._currentReelId=
null;return this},reset:function(){if(!this._frame)return this;var a=this._frame.currentReel[0];this.__coord[0]=a[0];this.__coord[1]=a[1];this.stop();return this},isPlaying:function(a){return!a?!!this._interval:this._currentReelId===a}});b.c("Tween",{_step:null,_numProps:0,tween:function(a,b){this.each(function(){null==this._step&&(this._step={},this.bind("EnterFrame",o),this.bind("RemoveComponent",function(a){"Tween"==a&&this.unbind("EnterFrame",o)}));for(var c in a)this._step[c]={prop:a[c],val:(a[c]-
this[c])/b,rem:b},this._numProps++});return this}});b.c("Color",{_color:"",ready:!0,init:function(){this.bind("Draw",function(a){"DOM"===a.type?(a.style.background=this._color,a.style.lineHeight=0):"canvas"===a.type&&(this._color&&(a.ctx.fillStyle=this._color),a.ctx.fillRect(a.pos._x,a.pos._y,a.pos._w,a.pos._h))})},color:function(a){if(!a)return this._color;this._color=a;this.trigger("Change");return this}});b.c("Tint",{_color:null,_strength:1,init:function(){var a=function(a){var c=a.ctx||b.canvas.context;
c.fillStyle=this._color||"rgb(0,0,0)";c.fillRect(a.pos._x,a.pos._y,a.pos._w,a.pos._h)};this.bind("Draw",a).bind("RemoveComponent",function(b){"Tint"===b&&this.unbind("Draw",a)})},tint:function(a,d){this._strength=d;this._color=b.toRGB(a,this._strength);this.trigger("Change");return this}});b.c("Image",{_repeat:"repeat",ready:!1,init:function(){var a=function(a){if("canvas"===a.type){if(this.ready&&this._pattern){var b=a.ctx;b.fillStyle=this._pattern;b.save();b.translate(a.pos._x,a.pos._y);b.fillRect(0,
0,this._w,this._h);b.restore()}}else"DOM"===a.type&&this.__image&&(a.style.background="url("+this.__image+") "+this._repeat)};this.bind("Draw",a).bind("RemoveComponent",function(b){"Image"===b&&this.unbind("Draw",a)})},image:function(a,d){this.__image=a;this._repeat=d||"no-repeat";if(this.img=b.asset(a)){if(this.ready=!0,this.has("Canvas")&&(this._pattern=b.canvas.context.createPattern(this.img,this._repeat)),"no-repeat"===this._repeat)this.w=this.img.width,this.h=this.img.height}else{this.img=new Image;
b.asset(a,this.img);this.img.src=a;var c=this;this.img.onload=function(){c.has("Canvas")&&(c._pattern=b.canvas.context.createPattern(c.img,c._repeat));c.ready=!0;"no-repeat"===c._repeat&&(c.w=c.img.width,c.h=c.img.height);c.trigger("Change")};return this}this.trigger("Change");return this}});b.extend({_scenes:[],_current:null,scene:function(a,d,c){if(1===arguments.length){b("2D").each(function(){this.has("Persist")||this.destroy()});null!==this._current&&"uninitialize"in this._scenes[this._current]&&
this._scenes[this._current].uninitialize.call(this);this._scenes[a].initialize.call(this);var e=this._current;this._current=a;b.trigger("SceneChange",{oldScene:e,newScene:a})}else this._scenes[a]={},this._scenes[a].initialize=d,"undefined"!==typeof c&&(this._scenes[a].uninitialize=c)},toRGB:function(a,b){var a="#"===a.charAt(0)?a.substr(1):a,c=[];c[0]=parseInt(a.substr(0,2),16);c[1]=parseInt(a.substr(2,2),16);c[2]=parseInt(a.substr(4,2),16);return void 0===b?"rgb("+c.join(",")+")":"rgba("+c.join(",")+
","+b+")"}});var x=b,F,z=[],C=[];F={total2D:b("2D").length,onScreen:function(a){return 0<b.viewport._x+a._x+a._w&&0<b.viewport._y+a._y+a._h&&b.viewport._x+a._x<b.viewport.width&&b.viewport._y+a._y<b.viewport.height},merge:function(a){do{for(var d=[],c=!1,e=0,f=a.length,i,h;e<f;)i=a[e],h=a[e+1],e<f-1&&i._x<h._x+h._w&&i._x+i._w>h._x&&i._y<h._y+h._h&&i._h+i._y>h._y?(c={_x:~~Math.min(i._x,h._x),_y:~~Math.min(i._y,h._y),_w:Math.max(i._x,h._x)+Math.max(i._w,h._w),_h:Math.max(i._y,h._y)+Math.max(i._h,h._h)},
c._w-=c._x,c._h-=c._y,c._w=c._w==~~c._w?c._w:c._w+1|0,c._h=c._h==~~c._h?c._h:c._h+1|0,d.push(c),e++,c=!0):d.push(i),e++;a=d.length?b.clone(d):a}while(c);return a},add:function(a,b){if(b){var c;c=a._mbr||a;var e=b._mbr||b;a===b?c=a.mbr()||a.pos():(c={_x:~~Math.min(c._x,e._x),_y:~~Math.min(c._y,e._y),_w:Math.max(c._w,e._w)+Math.max(c._x,e._x),_h:Math.max(c._h,e._h)+Math.max(c._y,e._y)},c._w-=c._x,c._h-=c._y);if(0===c._w||0===c._h||!this.onScreen(c))return!1;c._x=~~c._x;c._y=~~c._y;c._w=c._w===~~c._w?
c._w:c._w+1|0;c._h=c._h===~~c._h?c._h:c._h+1|0;z.push(c);return!0}C.push(a)},debug:function(){console.log(z,C)},drawAll:function(a){var a=a||b.viewport.rect(),d=b.map.search(a),c=0,e=d.length;b.canvas.context.clearRect(a._x,a._y,a._w,a._h);for(d.sort(function(a,b){return a._globalZ-b._globalZ});c<e;c++)a=d[c],a._visible&&a.__c.Canvas&&(a.draw(),a._changed=!1)},boundingRect:function(a){if(a&&a.length){for(var b=1,c=a.length,e,f=a[0],f=[f._x,f._y,f._x+f._w,f._y+f._h];b<c;)e=a[b],e=[e._x,e._y,e._x+e._w,
e._y+e._h],e[0]<f[0]&&(f[0]=e[0]),e[1]<f[1]&&(f[1]=e[1]),e[2]>f[2]&&(f[2]=e[2]),e[3]>f[3]&&(f[3]=e[3]),b++;e=f;return f={_x:e[0],_y:e[1],_w:e[2]-e[0],_h:e[3]-e[1]}}},draw:function(){if(z.length||C.length){for(var a=0,d=z.length,c=C.length,e,f,i,h,g,k=[],p=b.canvas.context;a<c;++a)C[a].draw()._changed=!1;C.length=0;if(d)if(0.6<d/this.total2D)this.drawAll(),z.length=0;else{z=this.merge(z);for(a=0;a<d;++a)if(c=z[a]){e=b.map.search(c,!1);h={};f=0;for(i=e.length;f<i;++f)g=e[f],!h[g[0]]&&(g._visible&&g.__c.Canvas)&&
(h[g[0]]=!0,k.push({obj:g,rect:c}));p.clearRect(c._x,c._y,c._w,c._h)}k.sort(function(a,b){return a.obj._globalZ-b.obj._globalZ});if(k.length){a=0;for(d=k.length;a<d;++a)g=k[a],c=g.rect,e=g.obj,f=e._mbr||e,i=0>c._y-f._y?0:~~(c._y-f._y),h=~~Math.min(f._w-(0>=c._x-f._x?0:~~(c._x-f._x)),c._w-(f._x-c._x),c._w,f._w),0===~~Math.min(f._h-i,c._h-(f._y-c._y),c._h,f._h)||0===h||(p.save(),p.beginPath(),p.moveTo(c._x,c._y),p.lineTo(c._x+c._w,c._y),p.lineTo(c._x+c._w,c._h+c._y),p.lineTo(c._x,c._h+c._y),p.lineTo(c._x,
c._y),p.clip(),e.draw(),p.closePath(),p.restore(),e._changed=!1);z.length=0;merged={}}}}}};x.DrawManager=F;b.extend({isometric:{_tile:{width:0,height:0},_elements:{},_pos:{x:0,y:0},_z:0,size:function(a,b){this._tile.width=a;this._tile.height=0<b?b:a/2;return this},place:function(a,d,c,e){a=this.pos2px(a,d);a.top-=c*(this._tile.width/2);e.attr({x:a.left+b.viewport._x,y:a.top+b.viewport._y}).z+=c;return this},pos2px:function(a,b){return{left:a*this._tile.width+(b&1)*(this._tile.width/2),top:b*this._tile.height/
2}},px2pos:function(a,b){return{x:Math.ceil(-a/this._tile.width-0.5*(b&1)),y:2*(-b/this._tile.height)}},centerAt:function(a,d){if("number"==typeof a&&"number"==typeof d){var c=this.pos2px(a,d);b.viewport._x=-c.left+b.viewport.width/2-this._tile.width/2;b.viewport._y=-c.top+b.viewport.height/2-this._tile.height/2;return this}return{top:-b.viewport._y+b.viewport.height/2-this._tile.height/2,left:-b.viewport._x+b.viewport.width/2-this._tile.width/2}},area:function(){var a=this.centerAt(),d=this.px2pos(-a.left+
b.viewport.width/2,-a.top+b.viewport.height/2),a=this.px2pos(-a.left-b.viewport.width/2,-a.top-b.viewport.height/2);return{x:{start:d.x,end:a.x},y:{start:d.y,end:a.y}}}}});b.c("Particles",{init:function(){this._Particles=b.clone(this._Particles)},particles:function(a){if(!b.support.canvas||b.deactivateParticles)return this;var d,c,e,f,g;d=n.createElement("canvas");d.width=b.viewport.width;d.height=b.viewport.height;d.style.position="absolute";b.stage.elem.appendChild(d);c=d.getContext("2d");this._Particles.init(a);
this.bind("Remove",function(){b.stage.elem.removeChild(d)}).bind("RemoveComponent",function(a){"particles"===a&&b.stage.elem.removeChild(d)});e=this.x+b.viewport.x;f=this.y+b.viewport.y;this._Particles.position=this._Particles.vectorHelpers.create(e,f);var h=b.viewport.x,m=b.viewport.y;this.bind("EnterFrame",function(){e=this.x+b.viewport.x;f=this.y+b.viewport.y;this._Particles.viewportDelta={x:b.viewport.x-h,y:b.viewport.y-m};h=b.viewport.x;m=b.viewport.y;this._Particles.position=this._Particles.vectorHelpers.create(e,
f);"function"==typeof b.DrawManager.boundingRect?(g=b.DrawManager.boundingRect(this._Particles.register))&&c.clearRect(g._x,g._y,g._w,g._h):c.clearRect(0,0,b.viewport.width,b.viewport.height);this._Particles.update();this._Particles.render(c)});return this},_Particles:{presets:{maxParticles:150,size:18,sizeRandom:4,speed:1,speedRandom:1.2,lifeSpan:29,lifeSpanRandom:7,angle:65,angleRandom:34,startColour:[255,131,0,1],startColourRandom:[48,50,45,0],endColour:[245,35,0,0],endColourRandom:[60,60,60,0],
sharpness:20,sharpnessRandom:10,spread:10,duration:-1,fastMode:!1,gravity:{x:0,y:0.1},jitter:0,particles:[],active:!0,particleCount:0,elapsedFrames:0,emissionRate:0,emitCounter:0,particleIndex:0},init:function(a){this.position=this.vectorHelpers.create(0,0);"undefined"==typeof a&&(a={});for(key in this.presets)this[key]="undefined"!=typeof a[key]?a[key]:this.presets[key];this.emissionRate=this.maxParticles/this.lifeSpan;this.positionRandom=this.vectorHelpers.create(this.spread,this.spread)},addParticle:function(){if(this.particleCount==
this.maxParticles)return!1;var a=new this.particle(this.vectorHelpers);this.initParticle(a);this.particles[this.particleCount]=a;this.particleCount++;return!0},RANDM1TO1:function(){return 2*Math.random()-1},initParticle:function(a){a.position.x=this.position.x+this.positionRandom.x*this.RANDM1TO1();a.position.y=this.position.y+this.positionRandom.y*this.RANDM1TO1();var b=(this.angle+this.angleRandom*this.RANDM1TO1())*(Math.PI/180),b=this.vectorHelpers.create(Math.sin(b),-Math.cos(b)),c=this.speed+
this.speedRandom*this.RANDM1TO1();a.direction=this.vectorHelpers.multiply(b,c);a.size=this.size+this.sizeRandom*this.RANDM1TO1();a.size=0>a.size?0:~~a.size;a.timeToLive=this.lifeSpan+this.lifeSpanRandom*this.RANDM1TO1();a.sharpness=this.sharpness+this.sharpnessRandom*this.RANDM1TO1();a.sharpness=100<a.sharpness?100:0>a.sharpness?0:a.sharpness;a.sizeSmall=~~(a.size/200*a.sharpness);b=[this.startColour[0]+this.startColourRandom[0]*this.RANDM1TO1(),this.startColour[1]+this.startColourRandom[1]*this.RANDM1TO1(),
this.startColour[2]+this.startColourRandom[2]*this.RANDM1TO1(),this.startColour[3]+this.startColourRandom[3]*this.RANDM1TO1()];c=[this.endColour[0]+this.endColourRandom[0]*this.RANDM1TO1(),this.endColour[1]+this.endColourRandom[1]*this.RANDM1TO1(),this.endColour[2]+this.endColourRandom[2]*this.RANDM1TO1(),this.endColour[3]+this.endColourRandom[3]*this.RANDM1TO1()];a.colour=b;a.deltaColour[0]=(c[0]-b[0])/a.timeToLive;a.deltaColour[1]=(c[1]-b[1])/a.timeToLive;a.deltaColour[2]=(c[2]-b[2])/a.timeToLive;
a.deltaColour[3]=(c[3]-b[3])/a.timeToLive},update:function(){if(this.active&&0<this.emissionRate){var a=1/this.emissionRate;for(this.emitCounter++;this.particleCount<this.maxParticles&&this.emitCounter>a;)this.addParticle(),this.emitCounter-=a;this.elapsedFrames++;-1!=this.duration&&this.duration<this.elapsedFrames&&this.stop()}this.particleIndex=0;this.register=[];for(var b;this.particleIndex<this.particleCount;){a=this.particles[this.particleIndex];if(0<a.timeToLive){a.direction=this.vectorHelpers.add(a.direction,
this.gravity);a.position=this.vectorHelpers.add(a.position,a.direction);a.position=this.vectorHelpers.add(a.position,this.viewportDelta);this.jitter&&(a.position.x+=this.jitter*this.RANDM1TO1(),a.position.y+=this.jitter*this.RANDM1TO1());a.timeToLive--;var c=a.colour[0]+=a.deltaColour[0],e=a.colour[1]+=a.deltaColour[1],f=a.colour[2]+=a.deltaColour[2],g=a.colour[3]+=a.deltaColour[3];b=[];b.push("rgba("+(255<c?255:0>c?0:~~c));b.push(255<e?255:0>e?0:~~e);b.push(255<f?255:0>f?0:~~f);b.push((1<g?1:0>g?
0:g.toFixed(2))+")");a.drawColour=b.join(",");this.fastMode||(b[3]="0)",a.drawColourEnd=b.join(","));this.particleIndex++}else this.particleIndex!=this.particleCount-1&&(this.particles[this.particleIndex]=this.particles[this.particleCount-1]),this.particleCount--;b={};b._x=~~a.position.x;b._y=~~a.position.y;b._w=a.size;b._h=a.size;this.register.push(b)}},stop:function(){this.active=!1;this.emitCounter=this.elapsedFrames=0},render:function(a){for(var d=0,c=this.particleCount;d<c;d++){var e=this.particles[d],
f=e.size,g=f>>1;if(!(0>e.position.x+f||0>e.position.y+f||e.position.x-f>b.viewport.width||e.position.y-f>b.viewport.height)){var h=~~e.position.x,m=~~e.position.y;this.fastMode?a.fillStyle=e.drawColour:(g=a.createRadialGradient(h+g,m+g,e.sizeSmall,h+g,m+g,g),g.addColorStop(0,e.drawColour),g.addColorStop(0.9,e.drawColourEnd),a.fillStyle=g);a.fillRect(h,m,f,f)}}},particle:function(a){this.position=a.create(0,0);this.direction=a.create(0,0);this.timeToLive=this.sizeSmall=this.size=0;this.colour=[];this.drawColour=
"";this.deltaColour=[];this.sharpness=0},vectorHelpers:{create:function(a,b){return{x:a,y:b}},multiply:function(a,b){a.x*=b;a.y*=b;return a},add:function(a,b){a.x+=b.x;a.y+=b.y;return a}}}});b.extend({audio:{sounds:{},supported:{},codecs:{ogg:'audio/ogg; codecs="vorbis"',wav:'audio/wav; codecs="1"',webma:'audio/webm; codecs="vorbis"',mp3:'audio/mpeg; codecs="mp3"',m4a:'audio/mp4; codecs="mp4a.40.2"'},volume:1,muted:!1,canPlay:function(){var a=this.audioElement(),b,c;for(c in this.codecs)b=a.canPlayType(this.codecs[c]),
this.supported[c]=""!==b&&"no"!==b?!0:!1},audioElement:function(){return"undefined"!==typeof Audio?new Audio(""):n.createElement("audio")},add:function(a,d){b.support.audio=!!this.audioElement().canPlayType;if(b.support.audio){this.canPlay();var c,e,f;if(1===arguments.length&&"object"===typeof a)for(var g in a)for(var h in a[g])c=this.audioElement(),c.id=g,c.preload="auto",c.volume=b.audio.volume,f=a[g][h],e=f.substr(f.lastIndexOf(".")+1).toLowerCase(),this.supported[e]&&(c.src=f,b.asset(f,c),this.sounds[g]=
{obj:c,played:0});if("string"===typeof a&&(c=this.audioElement(),c.id=a,c.preload="auto",c.volume=b.audio.volume,"string"===typeof d&&(e=d.substr(d.lastIndexOf(".")+1).toLowerCase(),this.supported[e]&&(c.src=d,b.asset(d,c),this.sounds[a]={obj:c,played:0})),"object"===typeof d))for(h in d)c=this.audioElement(),c.id=a,c.preload="auto",c.volume=b.audio.volume,f=d[h],e=f.substr(f.lastIndexOf(".")+1).toLowerCase(),this.supported[e]&&(c.src=f,b.asset(f,c),this.sounds[a]={obj:c,played:0})}},play:function(a,
d,c){if(!(0==d||!b.support.audio||!this.sounds[a])){var e=this.sounds[a];e.obj.volume=c||b.audio.volume;e.obj.currentTime&&(e.obj.currentTime=0);e.obj.play();e.played++;e.obj.addEventListener("ended",function(){if(e.played<d||d==-1){if(this.currentTime)this.currentTime=0;this.play();e.played++}},!0)}},stop:function(a){if(b.support.audio){var d;if(!a)for(var c in this.sounds)d=this.sounds[c],d.obj.paused||d.obj.pause();this.sounds[a]&&(d=this.sounds[a],d.obj.paused||d.obj.pause())}},mute:function(){if(b.support.audio){var a;
if(this.muted){for(d in this.sounds)a=this.sounds[d],a.obj.currentTime&&0<a.obj.currentTime&&this.sounds[d].obj.play();this.muted=!1}else{for(var d in this.sounds)a=this.sounds[d],a.obj.pause();this.muted=!0}}}}});b.c("Text",{_text:"",_textFont:{type:"",weight:"",size:"",family:""},ready:!0,init:function(){this.requires("2D");this.bind("Draw",function(a){var b=this._textFont.type+" "+this._textFont.weight+" "+this._textFont.size+" "+this._textFont.family;if("DOM"===a.type){var a=this._element,c=a.style;
c.color=this._textColor;c.font=b;a.innerHTML=this._text}else"canvas"===a.type&&(a=a.ctx,c=null,a.save(),a.fillStyle=this._textColor||"rgb(0,0,0)",a.font=b,a.translate(this.x,this.y+this.h),a.fillText(this._text,0,0),c=a.measureText(this._text),this._w=c.width,a.restore())})},text:function(a){if(!a)return this._text;this._text="function"==typeof a?a.call(this):a;this.trigger("Change");return this},textColor:function(a,d){this._strength=d;this._textColor=b.toRGB(a,this._strength);this.trigger("Change");
return this},textFont:function(a,b){if(1===arguments.length){if("string"===typeof a)return this._textFont[a];if("object"===typeof a)for(propertyKey in a)this._textFont[propertyKey]=a[propertyKey]}else this._textFont[a]=b;this.trigger("Change");return this}});b.extend({assets:{},asset:function(a,d){if(1===arguments.length)return b.assets[a];b.assets[a]||(b.assets[a]=d,this.trigger("NewAsset",{key:a,value:d}))},load:function(a,d,c,e){function f(){var a=this.src;this.removeEventListener&&this.removeEventListener("canplaythrough",
f,!1);++r;c&&c({loaded:r,total:n,percent:100*(r/n),src:a});r===n&&d&&d()}function g(){var a=this.src;e&&e({loaded:r,total:n,percent:100*(r/n),src:a});r++;r===n&&d&&d()}for(var h=0,m=a.length,k,p,n=m,r=0,o="";h<m;++h){k=a[h];o=k.substr(k.lastIndexOf(".")+1).toLowerCase();p=b.asset(k)||null;if(b.support.audio&&b.audio.supported[o])p||(o=k.substr(k.lastIndexOf("/")+1).toLowerCase(),p=b.audio.audioElement(),p.id=o,p.src=k,p.preload="auto",p.volume=b.audio.volume,b.asset(k,p),b.audio.sounds[o]={obj:p,
played:0}),p.addEventListener&&p.addEventListener("canplaythrough",f,!1);else if("jpg"===o||"jpeg"===o||"gif"===o||"png"===o)p||(p=new Image,b.asset(k,p)),p.onload=f,p.src=k;else{n--;continue}p.onerror=g}},modules:function(a,b,c){2===arguments.length&&"object"===typeof a&&(c=b,b=a,a="http://cdn.craftycomponents.com");var e=function(){function a(b,d,c){c=0;for(j=b.length;c<j;++c)if(!d(b[c]))return u;return 1}function b(d,c){a(d,function(a){return!c(a)})}function d(e,f,g){function i(a){return a.call?
a():o[a]}function n(){if(!--x){o[w]=1;u&&u();for(var d in s)a(d.split("|"),i)&&!b(s[d],i)&&(s[d]=[])}}var e=e[z]?e:[e],r=f&&f.call,u=r?f:g,w=r?e.join(""):f,x=e.length;setTimeout(function(){b(e,function(a){if(v[a])return v[a]==2&&n();v[a]=1;c(!h.test(a)&&t?t+a+".js":a,n)})},0);return d}function c(a,b){var d=f.createElement("script"),e=u;d.onload=d.onerror=d[B]=function(){if(!(d[x]&&!/^c|loade/.test(d[x])||e)){d.onload=d[B]=null;e=1;v[a]=2;b()}};d.async=1;d.src=a;g.insertBefore(d,g.firstChild)}var e=
this,f=n,g=f.getElementsByTagName("head")[0],h=/^https?:\/\//,i=e.$script,o={},s={},t,v={},u=false,z="push",x="readyState",B="onreadystatechange";if(!f[x]&&f.addEventListener){f.addEventListener("DOMContentLoaded",function G(){f.removeEventListener("DOMContentLoaded",G,u);f[x]="complete"},u);f[x]="loading"}d.get=c;d.order=function(a,b,c){(function H(e){e=a.shift();a.length?d(e,H):d(e,b,c)})()};d.path=function(a){t=a};d.ready=function(c,e,f){var c=c[z]?c:[c],g=[];if(!b(c,function(a){o[a]||g[z](a)})&&
a(c,function(a){return o[a]}))e();else{c=c.join("|");s[c]=s[c]||[];s[c][z](e);f&&f(g);true}return d};d.noConflict=function(){e.$script=i;return this};return d}(),f=[],g=/^(https?|file):\/\//,h;for(h in b)g.test(h)?f.push(h):f.push(a+"/"+h.toLowerCase()+"-"+b[h].toLowerCase()+".js");e(f,function(){c&&c()})}});b.math={abs:function(a){return 0>a?-a:a},amountOf:function(a,b,c){return b<c?(a-b)/(c-b):(a-c)/(b-c)},clamp:function(a,b,c){return a>c?c:a<b?b:a},degToRad:function(a){return a*Math.PI/180},distance:function(a,
d,c,e){a=b.math.squaredDistance(a,d,c,e);return Math.sqrt(parseFloat(a))},lerp:function(a,b,c){return a+(b-a)*c},negate:function(a){return Math.random()<a?-1:1},radToDeg:function(a){return 180*a/Math.PI},randomElementOfArray:function(a){return a[Math.floor(a.length*Math.random())]},randomInt:function(a,b){return a+Math.floor((1+b-a)*Math.random())},randomNumber:function(a,b){return a+(b-a)*Math.random()},squaredDistance:function(a,b,c,e){return(a-c)*(a-c)+(b-e)*(b-e)},withinRange:function(a,b,c){return a>=
b&&a<=c}};var x=b.math,s=function(a,b){if(a instanceof s)this.x=a.x,this.y=a.y;else if(2===arguments.length)this.x=a,this.y=b;else if(0<arguments.length)throw"Unexpected number of arguments for Vector2D()";};s.prototype.x=0;s.prototype.y=0;s.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};s.prototype.angleBetween=function(a){return Math.atan2(this.x*a.y-this.y*a.x,this.x*a.x+this.y*a.y)};s.prototype.angleTo=function(a){return Math.atan2(a.y-this.y,a.x-this.x)};s.prototype.clone=function(){return new s(this)};
s.prototype.distance=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))};s.prototype.distanceSq=function(a){return(a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y)};s.prototype.divide=function(a){this.x/=a.x;this.y/=a.y;return this};s.prototype.dotProduct=function(a){return this.x*a.x+this.y*a.y};s.prototype.equals=function(a){return a instanceof s&&this.x==a.x&&this.y==a.y};s.prototype.getNormal=function(a){return void 0===a?new s(-this.y,this.x):(new s(a.y-this.y,
this.x-a.x)).normalize()};s.prototype.isZero=function(){return 0===this.x&&0===this.y};s.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};s.prototype.magnitudeSq=function(){return this.x*this.x+this.y*this.y};s.prototype.multiply=function(a){this.x*=a.x;this.y*=a.y;return this};s.prototype.negate=function(){this.x=-this.x;this.y=-this.y;return this};s.prototype.normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);0===a?(this.x=1,this.y=0):(this.x/=a,this.y/=
a);return this};s.prototype.scale=function(a,b){void 0===b&&(b=a);this.x*=a;this.y*=b;return this};s.prototype.scaleToMagnitude=function(a){a/=this.magnitude();this.x*=a;this.y*=a;return this};s.prototype.setValues=function(a,b){a instanceof s?(this.x=a.x,this.y=a.y):(this.x=a,this.y=b);return this};s.prototype.subtract=function(a){this.x-=a.x;this.y-=a.y;return this};s.prototype.toString=function(){return"Vector2D("+this.x+", "+this.y+")"};s.prototype.translate=function(a,b){void 0===b&&(b=a);this.x+=
a;this.y+=b;return this};s.tripleProduct=function(a,d,c){var e=a.dotProduct(c),c=d.dotProduct(c);return new b.math.Vector2D(d.x*e-a.x*c,d.y*e-a.y*c)};x.Vector2D=s;x=b.math;Matrix2D=function(a,b,c,e,f,g){if(a instanceof Matrix2D)this.a=a.a,this.b=a.b,this.c=a.c,this.d=a.d,this.e=a.e,this.f=a.f;else if(6===arguments.length)this.a=a,this.b=b,this.c=c,this.d=e,this.e=f,this.f=g;else if(0<arguments.length)throw"Unexpected number of arguments for Matrix2D()";};Matrix2D.prototype.a=1;Matrix2D.prototype.b=
0;Matrix2D.prototype.c=0;Matrix2D.prototype.d=1;Matrix2D.prototype.e=0;Matrix2D.prototype.f=0;Matrix2D.prototype.apply=function(a){var b=a.x;a.x=b*this.a+a.y*this.c+this.e;a.y=b*this.b+a.y*this.d+this.f;return a};Matrix2D.prototype.clone=function(){return new Matrix2D(this)};Matrix2D.prototype.combine=function(a){var b=this.a;this.a=b*a.a+this.b*a.c;this.b=b*a.b+this.b*a.d;b=this.c;this.c=b*a.a+this.d*a.c;this.d=b*a.b+this.d*a.d;b=this.e;this.e=b*a.a+this.f*a.c+a.e;this.f=b*a.b+this.f*a.d+a.f;return this};
Matrix2D.prototype.equals=function(a){return a instanceof Matrix2D&&this.a==a.a&&this.b==a.b&&this.c==a.c&&this.d==a.d&&this.e==a.e&&this.f==a.f};Matrix2D.prototype.determinant=function(){return this.a*this.d-this.b*this.c};Matrix2D.prototype.invert=function(){var a=this.determinant();if(0!==a){var b=this.a,c=this.b,e=this.c,f=this.d,g=this.e,h=this.f;this.a=f/a;this.b=-c/a;this.c=-e/a;this.d=b/a;this.e=(e*h-g*f)/a;this.f=(g*c-b*h)/a}return this};Matrix2D.prototype.isIdentity=function(){return 1===
this.a&&0===this.b&&0===this.c&&1===this.d&&0===this.e&&0===this.f};Matrix2D.prototype.isInvertible=function(){return 0!==this.determinant()};Matrix2D.prototype.preRotate=function(a){var b=Math.cos(a),a=Math.sin(a),c=this.a;this.a=b*c-a*this.b;this.b=a*c+b*this.b;c=this.c;this.c=b*c-a*this.d;this.d=a*c+b*this.d;return this};Matrix2D.prototype.preScale=function(a,b){void 0===b&&(b=a);this.a*=a;this.b*=b;this.c*=a;this.d*=b;return this};Matrix2D.prototype.preTranslate=function(a,b){"number"===typeof a?
(this.e+=a,this.f+=b):(this.e+=a.x,this.f+=a.y);return this};Matrix2D.prototype.rotate=function(a){var b=Math.cos(a),a=Math.sin(a),c=this.a;this.a=b*c-a*this.b;this.b=a*c+b*this.b;c=this.c;this.c=b*c-a*this.d;this.d=a*c+b*this.d;c=this.e;this.e=b*c-a*this.f;this.f=a*c+b*this.f;return this};Matrix2D.prototype.scale=function(a,b){void 0===b&&(b=a);this.a*=a;this.b*=b;this.c*=a;this.d*=b;this.e*=a;this.f*=b;return this};Matrix2D.prototype.setValues=function(a,b,c,e,f,g){a instanceof Matrix2D?(this.a=
a.a,this.b=a.b,this.c=a.c,this.d=a.d,this.e=a.e,this.f=a.f):(this.a=a,this.b=b,this.c=c,this.d=e,this.e=f,this.f=g);return this};Matrix2D.prototype.toString=function(){return"Matrix2D(["+this.a+", "+this.c+", "+this.e+"] ["+this.b+", "+this.d+", "+this.f+"] [0, 0, 1])"};Matrix2D.prototype.translate=function(a,b){"number"===typeof a?(this.e+=this.a*a+this.c*b,this.f+=this.b*a+this.d*b):(this.e+=this.a*a.x+this.c*a.y,this.f+=this.b*a.x+this.d*a.y);return this};x.Matrix2D=Matrix2D;b.c("Delay",{init:function(){this._delays=
[];this.bind("EnterFrame",function(){var a=(new Date).getTime(),b;for(b in this._delays){var c=this._delays[b];!c.triggered&&c.start+c.delay+c.pause<a&&(c.triggered=!0,c.func.call(this))}});this.bind("Pause",function(){var a=(new Date).getTime(),b;for(b in this._delays)this._delays[b].pauseBuffer=a});this.bind("Unpause",function(){var a=(new Date).getTime(),b;for(b in this._delays){var c=this._delays[b];c.pause+=a-c.pauseBuffer}})},delay:function(a,b){return this._delays.push({start:(new Date).getTime(),
func:a,delay:b,triggered:!1,pauseBuffer:0,pause:0})}})})(Crafty,window,window.document);window.onload=function(){Crafty.init(1280,720);Crafty.canvas.init();Crafty.sprite(20,47,"/sprites/formula_05_blue_small.png",{car_player:[0,0]});Crafty.scene("loading_game")};var selectedTrack="",trackData={},trackList=[],racetime=0,starttime=0;updatePreview=function(b){preview.updateThumbnail(b);preview.updateTrackInfo(b)};playTrack=function(b){trackData=b;Crafty.scene("loading_track")};
showRecordForm=function(b){document.getElementById("recordform").innerHTML=b;var b=document.getElementById("seconds").innerHTML,b=new Date(parseInt(b)),g=b.getMilliseconds();2==g.length?g="0"+g:1==g.length&&(g="00"+g);b=b.getSeconds()+"s "+g+"ms";document.getElementById("seconds").innerHTML=b};submitRecord=function(){trackid=document.getElementById("trackid").value;record=document.getElementById("record").value;player=document.getElementById("name").value;saveTrackRecord(trackid,player,record)};
returnToMenu=function(){Crafty.scene("choose_track")};Crafty.scene("loading_game",function(){background=Crafty.e("2D, Canvas, Image").image("/sprites/loading_01.png");Crafty.background("/sprites/loading_01.png");load=["/sprites/formula_05_blue_small.png","/sprites/loading_01.png","/sprites/menu_01.png"];Crafty.load(load,function(){Crafty.scene("choose_track")})});
Crafty.scene("choose_track",function(){background=Crafty.e("2D, Canvas, Image").image("/sprites/menu_01.png");trackMenu=Crafty.e("Selector, TrackList").TrackList().Selector();preview=Crafty.e("Thumbnail, TrackInfo").TrackInfo().attr({x:900,y:80}).bind("SelectorMoved",function(b){trackMenu.getTrackPreviewData(b.index)}).bind("TrackSelected",function(){selectedTrack=trackMenu.getId(trackMenu.getSelectorIndex());Crafty.scene("fetching_track")})});
Crafty.scene("fetching_track",function(){background=Crafty.e("2D, Canvas, Image").image("/sprites/loading_01.png");requestTrackData(selectedTrack);trackMenu.destroy();preview.destroy()});Crafty.scene("loading_track",function(){background=Crafty.e("2D, Canvas, Image").image("/sprites/loading_01.png");load=["/tracks/texture/"+trackData.handle+".png","/tracks/mapdata/"+trackData.handle+".png"];Crafty.load(load,function(){Crafty.scene("play")})});
Crafty.scene("play",function(){starttime=0;var b=-2E3;CurrentMap=trackData;mapdata=Crafty.e("MapData").MapData("/tracks/mapdata/"+CurrentMap.handle+".png");texture=Crafty.e("Map").Map(CurrentMap);stopwatch=Crafty.e("SpriteFontWriter").SpriteFontWriter(5,15).bind("EnterFrame",function(g){0!=starttime&&(racetime=20*g.frame,racetime-=starttime,g=new Date(racetime),100<g-b&&(this.eraseText(),g.getMilliseconds(),this.setContent(g.getSeconds()+" "+g.getMilliseconds()),this.writeText(),b=g))});car=Crafty.e("2D, Canvas, car_player, Car, Keyboard").origin("center").attr({x:CurrentMap.init_x,
y:CurrentMap.init_y}).Car(CurrentMap.init_dir)});Crafty.scene("race_over",function(){stopwatch.destroy();background=Crafty.e("2D, Canvas, Image").image("/sprites/menu_01.png");mapdata.destroy();texture.destroy();car.destroy();requestRecordForm(selectedTrack,racetime)});Crafty.c("Map",{init:function(){this.requires("2D, Canvas, Image");this.z=-2},Map:function(b){this.image("/tracks/texture/"+b.handle+".png");this.numCheckpoints=b.checkpoints;return this},getNumberOfCheckpoints:function(){return this.numCheckpoints}});Crafty.c("MapData",{_imgd:[],_floor:[],init:function(){},MapData:function(b){var g=Crafty.canvas.context;g.drawImage(Crafty.asset(b),0,0);this._imgd=g.getImageData(0,0,1280,720);for(var b=this._imgd.data,g=this._imgd.width*this._imgd.height,n={"0":"black",16777215:"white",65313:"A",16711680:"B",9983:"goal"},o=0,B=0;o<g;o++,B+=4)pixel=65536*b[B]+256*b[B+1]+b[B+2],this._floor[o]=n[pixel];return this},getPixel:function(b,g){return 0>b||0>g||b>this._imgd.width||g>this._imgd.height?void 0:this._floor[b+
g*this._imgd.width]},getSpeed:function(b,g){return{black:1,white:0.5,A:1,B:1,goal:1}[this.getPixel(parseInt(b),parseInt(g))]||1}});Crafty.c("Selector",{init:function(){this.requires("Keyboard")},Selector:function(){return this},enableSelector:function(){this.max=this.getListLength()-1;this.trackIndex=0;this.bind("KeyDown",function(b){if(b.keyCode==Crafty.keys.W||b.keyCode==Crafty.keys.UP_ARROW)0==this.trackIndex?this.trackIndex=this.max:this.trackIndex--,Crafty.trigger("SelectorMoved",{index:this.trackIndex});if(b.keyCode==Crafty.keys.S||b.keyCode==Crafty.keys.DOWN_ARROW)this.trackIndex==this.max?this.trackIndex=0:this.trackIndex++,
Crafty.trigger("SelectorMoved",{index:this.trackIndex});b.keyCode==Crafty.keys.SPACE&&Crafty.trigger("TrackSelected",{index:this.trackIndex})})},getSelectorIndex:function(){return this.trackIndex}});var xmlhttp;xmlhttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");requestTrackList=function(b){xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState&&200==xmlhttp.status){var g=JSON.parse(xmlhttp.responseText);b.listResponseHandler(g.tracks)}};xmlhttp.open("POST","/tracks",!0);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send("")};
requestTrackPreview=function(b){xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState&&200==xmlhttp.status){var b=JSON.parse(xmlhttp.responseText);updatePreview(b)}};xmlhttp.open("POST","/"+b+"/preview",!0);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send("")};
requestTrackData=function(b){xmlhttp.onreadystatechange=function(){if(4==xmlhttp.readyState&&200==xmlhttp.status){var b=JSON.parse(xmlhttp.responseText);playTrack(b)}};xmlhttp.open("POST","/"+b+"/data",!0);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send("")};
requestRecordForm=function(b,g){xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&showRecordForm(xmlhttp.responseText)};xmlhttp.open("POST","/"+b+"/recordform/"+g,!0);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send("")};
saveTrackRecord=function(b,g,n){xmlhttp.onreadystatechange=function(){4==xmlhttp.readyState&&200==xmlhttp.status&&(JSON.parse(xmlhttp.responseText),document.getElementById("recordform").innerHTML="",returnToMenu())};xmlhttp.open("POST","/"+b+"/newrecord/"+g+"/"+n,!0);xmlhttp.setRequestHeader("Content-type","application/x-www-form-urlencoded");xmlhttp.send("")};Crafty.c("Thumbnail",{init:function(){this.requires("2D, Canvas, Image")},Thumbnail:function(){return this},updateThumbnail:function(b){this.image("/tracks/thumb/"+b.handle+".png")}});Crafty.c("TrackInfo",{init:function(){},TrackInfo:function(){this.info={entry1:Crafty.e("SpriteFontWriter").SpriteFontWriter(900,230),entry2:Crafty.e("SpriteFontWriter").SpriteFontWriter(900,260),entry3:Crafty.e("SpriteFontWriter").SpriteFontWriter(900,290),name:Crafty.e("SpriteFontWriter").SpriteFontWriter(900,30)};return this},updateTrackInfo:function(b){var g=0,g="";0<b.records.length?(g=new Date(b.records[0][1]),g=g.getSeconds()+"s "+g.getMilliseconds()+"ms",this.info.entry1.setContent(b.records[0][0]+
"   "+g)):this.info.entry1.setContent(" ");this.info.entry1.eraseText();this.info.entry1.writeText();1<b.records.length?(g=new Date(b.records[1][1]),g=g.getSeconds()+"s "+g.getMilliseconds()+"ms",this.info.entry2.setContent(b.records[1][0]+"   "+g)):this.info.entry2.setContent(" ");this.info.entry2.eraseText();this.info.entry2.writeText();2<b.records.length?(g=new Date(b.records[2][1]),g=g.getSeconds()+"s "+g.getMilliseconds()+"ms",this.info.entry3.setContent(b.records[2][0]+"   "+g)):this.info.entry3.setContent(" ");
this.info.entry3.eraseText();this.info.entry3.writeText();this.info.name.setContent(b.name);this.info.name.eraseText();this.info.name.writeText()}});Crafty.c("TrackList",{init:function(){this.requires("2D, Image, Canvas")},TrackList:function(){this.tracks=[];requestTrackList(this);this.bind("SelectorMoved",function(b){for(var g in this.tracks)g==b.index?this.tracks[g].highlight():this.tracks[g].dehighlight()});return this},listResponseHandler:function(b){for(var g in b)this.tracks.push(Crafty.e("TrackListEntry, SpriteFontWriter").TrackListEntry(b[g]).SpriteFontWriter(5,20*g+5)),this.tracks[g].setContent(this.tracks[g].getTrackName()),this.tracks[g].eraseText(),
this.tracks[g].writeText();this.enableSelector();this.getTrackPreviewData(0);this.tracks[0].highlight()},getListLength:function(){return this.tracks.length},getId:function(b){return this.tracks[b].getTrackId()},getTrackPreviewData:function(b){requestTrackPreview(this.tracks[b].getTrackId())}});Crafty.c("TrackListEntry",{init:function(){},TrackListEntry:function(b){this.id=b.id;this.name=b.name;return this},getTrackName:function(){return this.name},getTrackId:function(){return this.id}});